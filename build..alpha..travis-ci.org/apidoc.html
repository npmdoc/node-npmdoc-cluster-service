<div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api documentation for
    <a

        href="https://github.com/godaddy/node-cluster-service"

    >cluster-service (v2.0.0)</a>
</h1>
<h4>Turns your single process code into a fault-resilient multi-process service with built-in REST & CLI support</h4>
<div class="apidocSectionDiv"><a
    href="#apidoc.tableOfContents"
    id="apidoc.tableOfContents"
><h1>table of contents</h1></a><ol>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service">module cluster-service</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.control">
            function <span class="apidocSignatureSpan">cluster-service.</span>control
            <span class="apidocSignatureSpan">(controls)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.debug">
            function <span class="apidocSignatureSpan">cluster-service.</span>debug
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.error">
            function <span class="apidocSignatureSpan">cluster-service.</span>error
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.exit">
            function <span class="apidocSignatureSpan">cluster-service.</span>exit
            <span class="apidocSignatureSpan">(evt, cb, cmd)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.health">
            function <span class="apidocSignatureSpan">cluster-service.</span>health
            <span class="apidocSignatureSpan">(evt, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.help">
            function <span class="apidocSignatureSpan">cluster-service.</span>help
            <span class="apidocSignatureSpan">(evt, cb, cmdName)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.info">
            function <span class="apidocSignatureSpan">cluster-service.</span>info
            <span class="apidocSignatureSpan">(evt, cb, cmd)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.locals">
            function <span class="apidocSignatureSpan">cluster-service.</span>locals
            <span class="apidocSignatureSpan">(evt, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.log">
            function <span class="apidocSignatureSpan">cluster-service.</span>log
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.netStats">
            function <span class="apidocSignatureSpan">cluster-service.</span>netStats
            <span class="apidocSignatureSpan">(server)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.newWorker">
            function <span class="apidocSignatureSpan">cluster-service.</span>newWorker
            <span class="apidocSignatureSpan">(options, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.on">
            function <span class="apidocSignatureSpan">cluster-service.</span>on
            <span class="apidocSignatureSpan">(eventName, cb, overwriteExisting)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.options">
            function <span class="apidocSignatureSpan">cluster-service.</span>options
            <span class="apidocSignatureSpan">(evt, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.processSafeSend">
            function <span class="apidocSignatureSpan">cluster-service.</span>processSafeSend
            <span class="apidocSignatureSpan">(process, msg)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.registerCommands">
            function <span class="apidocSignatureSpan">cluster-service.</span>registerCommands
            <span class="apidocSignatureSpan">(commands, overwriteExisting)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.restart">
            function <span class="apidocSignatureSpan">cluster-service.</span>restart
            <span class="apidocSignatureSpan">(evt, cb, cmd, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.results">
            function <span class="apidocSignatureSpan">cluster-service.</span>results
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.shutdown">
            function <span class="apidocSignatureSpan">cluster-service.</span>shutdown
            <span class="apidocSignatureSpan">(evt, cb, cmd, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.start">
            function <span class="apidocSignatureSpan">cluster-service.</span>start
            <span class="apidocSignatureSpan">(options, masterCb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.stop">
            function <span class="apidocSignatureSpan">cluster-service.</span>stop
            <span class="apidocSignatureSpan">(timeout, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.trigger">
            function <span class="apidocSignatureSpan">cluster-service.</span>trigger
            <span class="apidocSignatureSpan">(eventName, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.upgrade">
            function <span class="apidocSignatureSpan">cluster-service.</span>upgrade
            <span class="apidocSignatureSpan">(evt, cb, cmd, workerPath, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.version">
            function <span class="apidocSignatureSpan">cluster-service.</span>version
            <span class="apidocSignatureSpan">(evt, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.workerExit">
            function <span class="apidocSignatureSpan">cluster-service.</span>workerExit
            <span class="apidocSignatureSpan">(evt, cb, worker, reason)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.workerReady">
            function <span class="apidocSignatureSpan">cluster-service.</span>workerReady
            <span class="apidocSignatureSpan">(options, forceIsWorker)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.workerStart">
            function <span class="apidocSignatureSpan">cluster-service.</span>workerStart
            <span class="apidocSignatureSpan">(evt, cb, worker, reason)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">cluster-service.</span>cli</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">cluster-service.</span>cluster_service</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">cluster-service.</span>commands</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">cluster-service.</span>http_client</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">cluster-service.</span>http_server</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">cluster-service.</span>master</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">cluster-service.</span>msgBus</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">cluster-service.</span>netServers</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">cluster-service.</span>proxy</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">cluster-service.</span>run</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">cluster-service.</span>util</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">cluster-service.</span>workers</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.cli">module cluster-service.cli</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.cli.close">
            function <span class="apidocSignatureSpan">cluster-service.cli.</span>close
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.cli.init">
            function <span class="apidocSignatureSpan">cluster-service.cli.</span>init
            <span class="apidocSignatureSpan">(o)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.cluster_service">module cluster-service.cluster_service</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.cluster_service.control">
            function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>control
            <span class="apidocSignatureSpan">(controls)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.cluster_service.debug">
            function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>debug
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.cluster_service.error">
            function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>error
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.cluster_service.log">
            function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>log
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.cluster_service.netStats">
            function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>netStats
            <span class="apidocSignatureSpan">(server)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.cluster_service.newWorker">
            function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>newWorker
            <span class="apidocSignatureSpan">(options, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.cluster_service.on">
            function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>on
            <span class="apidocSignatureSpan">(eventName, cb, overwriteExisting)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.cluster_service.processSafeSend">
            function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>processSafeSend
            <span class="apidocSignatureSpan">(process, msg)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.cluster_service.registerCommands">
            function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>registerCommands
            <span class="apidocSignatureSpan">(commands, overwriteExisting)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.cluster_service.results">
            function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>results
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.cluster_service.start">
            function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>start
            <span class="apidocSignatureSpan">(options, masterCb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.cluster_service.stop">
            function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>stop
            <span class="apidocSignatureSpan">(timeout, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.cluster_service.trigger">
            function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>trigger
            <span class="apidocSignatureSpan">(eventName, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.cluster_service.workerReady">
            function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>workerReady
            <span class="apidocSignatureSpan">(options, forceIsWorker)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>msgBus</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>netServers</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>proxy</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.commands">module cluster-service.commands</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.commands.on">
            function <span class="apidocSignatureSpan">cluster-service.commands.</span>on
            <span class="apidocSignatureSpan">(eventName, cb, overwriteExisting)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.commands.register">
            function <span class="apidocSignatureSpan">cluster-service.commands.</span>register
            <span class="apidocSignatureSpan">(commands, overwriteExisting)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.control">module cluster-service.control</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.control.addControls">
            function <span class="apidocSignatureSpan">cluster-service.control.</span>addControls
            <span class="apidocSignatureSpan">(controls)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.control.authorize">
            function <span class="apidocSignatureSpan">cluster-service.control.</span>authorize
            <span class="apidocSignatureSpan">(name, currentControl, accessKey)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.control.setAccessKey">
            function <span class="apidocSignatureSpan">cluster-service.control.</span>setAccessKey
            <span class="apidocSignatureSpan">(keys)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.control.setControls">
            function <span class="apidocSignatureSpan">cluster-service.control.</span>setControls
            <span class="apidocSignatureSpan">(controls)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">cluster-service.control.</span>levels</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.exit">module cluster-service.exit</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.exit.exit">
            function <span class="apidocSignatureSpan">cluster-service.</span>exit
            <span class="apidocSignatureSpan">(evt, cb, cmd)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.exit.control">
            function <span class="apidocSignatureSpan">cluster-service.exit.</span>control
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.exit.more">
            function <span class="apidocSignatureSpan">cluster-service.exit.</span>more
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.health">module cluster-service.health</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.health.health">
            function <span class="apidocSignatureSpan">cluster-service.</span>health
            <span class="apidocSignatureSpan">(evt, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.health.more">
            function <span class="apidocSignatureSpan">cluster-service.health.</span>more
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.help">module cluster-service.help</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.help.help">
            function <span class="apidocSignatureSpan">cluster-service.</span>help
            <span class="apidocSignatureSpan">(evt, cb, cmdName)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.help.control">
            function <span class="apidocSignatureSpan">cluster-service.help.</span>control
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.help.more">
            function <span class="apidocSignatureSpan">cluster-service.help.</span>more
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.http_client">module cluster-service.http_client</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.http_client.execute">
            function <span class="apidocSignatureSpan">cluster-service.http_client.</span>execute
            <span class="apidocSignatureSpan">(question, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.http_client.init">
            function <span class="apidocSignatureSpan">cluster-service.http_client.</span>init
            <span class="apidocSignatureSpan">(o)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.http_server">module cluster-service.http_server</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.http_server.close">
            function <span class="apidocSignatureSpan">cluster-service.http_server.</span>close
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.http_server.init">
            function <span class="apidocSignatureSpan">cluster-service.http_server.</span>init
            <span class="apidocSignatureSpan">(o, cb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.info">module cluster-service.info</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.info.info">
            function <span class="apidocSignatureSpan">cluster-service.</span>info
            <span class="apidocSignatureSpan">(evt, cb, cmd)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.info.control">
            function <span class="apidocSignatureSpan">cluster-service.info.</span>control
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.info.more">
            function <span class="apidocSignatureSpan">cluster-service.info.</span>more
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.locals">module cluster-service.locals</a><ol>

        <li>

            <span class="apidocSignatureSpan">boolean <span class="apidocSignatureSpan">cluster-service.locals.</span>visible</span>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.locals.locals">
            function <span class="apidocSignatureSpan">cluster-service.</span>locals
            <span class="apidocSignatureSpan">(evt, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.locals.control">
            function <span class="apidocSignatureSpan">cluster-service.locals.</span>control
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.locals.more">
            function <span class="apidocSignatureSpan">cluster-service.locals.</span>more
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.master">module cluster-service.master</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.master.start">
            function <span class="apidocSignatureSpan">cluster-service.master.</span>start
            <span class="apidocSignatureSpan">(options, cb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.msgBus">module cluster-service.msgBus</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.msgBus.createMessage">
            function <span class="apidocSignatureSpan">cluster-service.msgBus.</span>createMessage
            <span class="apidocSignatureSpan">(cmd, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.msgBus.isValidMessage">
            function <span class="apidocSignatureSpan">cluster-service.msgBus.</span>isValidMessage
            <span class="apidocSignatureSpan">(msg)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.msgBus.processMessage">
            function <span class="apidocSignatureSpan">cluster-service.msgBus.</span>processMessage
            <span class="apidocSignatureSpan">(msg)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.msgBus.respondToMessage">
            function <span class="apidocSignatureSpan">cluster-service.msgBus.</span>respondToMessage
            <span class="apidocSignatureSpan">(msg, process, error, response)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.msgBus.sendMessage">
            function <span class="apidocSignatureSpan">cluster-service.msgBus.</span>sendMessage
            <span class="apidocSignatureSpan">(cmd, options, filter, cb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.netServers">module cluster-service.netServers</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.netServers.add">
            function <span class="apidocSignatureSpan">cluster-service.netServers.</span>add
            <span class="apidocSignatureSpan">(servers)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.netServers.close">
            function <span class="apidocSignatureSpan">cluster-service.netServers.</span>close
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.netServers.remove">
            function <span class="apidocSignatureSpan">cluster-service.netServers.</span>remove
            <span class="apidocSignatureSpan">(servers)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.netServers.waitForReady">
            function <span class="apidocSignatureSpan">cluster-service.netServers.</span>waitForReady
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.options">module cluster-service.options</a><ol>

        <li>

            <span class="apidocSignatureSpan">boolean <span class="apidocSignatureSpan">cluster-service.options.</span>visible</span>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.options.options">
            function <span class="apidocSignatureSpan">cluster-service.</span>options
            <span class="apidocSignatureSpan">(evt, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.options.control">
            function <span class="apidocSignatureSpan">cluster-service.options.</span>control
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.options.more">
            function <span class="apidocSignatureSpan">cluster-service.options.</span>more
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.proxy">module cluster-service.proxy</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.proxy.getProxyWorkers">
            function <span class="apidocSignatureSpan">cluster-service.proxy.</span>getProxyWorkers
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.proxy.getVersionWorkers">
            function <span class="apidocSignatureSpan">cluster-service.proxy.</span>getVersionWorkers
            <span class="apidocSignatureSpan">(explicitVersion)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.proxy.info">
            function <span class="apidocSignatureSpan">cluster-service.proxy.</span>info
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.proxy.promote">
            function <span class="apidocSignatureSpan">cluster-service.proxy.</span>promote
            <span class="apidocSignatureSpan">(versionStr, options, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.proxy.start">
            function <span class="apidocSignatureSpan">cluster-service.proxy.</span>start
            <span class="apidocSignatureSpan">(options, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.proxy.stop">
            function <span class="apidocSignatureSpan">cluster-service.proxy.</span>stop
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.proxy.updateProxyWorkers">
            function <span class="apidocSignatureSpan">cluster-service.proxy.</span>updateProxyWorkers
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.proxy.version">
            function <span class="apidocSignatureSpan">cluster-service.proxy.</span>version
            <span class="apidocSignatureSpan">(versionStr, options, cb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.restart">module cluster-service.restart</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.restart.restart">
            function <span class="apidocSignatureSpan">cluster-service.</span>restart
            <span class="apidocSignatureSpan">(evt, cb, cmd, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.restart.more">
            function <span class="apidocSignatureSpan">cluster-service.restart.</span>more
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.run">module cluster-service.run</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.run.start">
            function <span class="apidocSignatureSpan">cluster-service.run.</span>start
            <span class="apidocSignatureSpan">(o, cb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.shutdown">module cluster-service.shutdown</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.shutdown.shutdown">
            function <span class="apidocSignatureSpan">cluster-service.</span>shutdown
            <span class="apidocSignatureSpan">(evt, cb, cmd, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.shutdown.control">
            function <span class="apidocSignatureSpan">cluster-service.shutdown.</span>control
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.shutdown.more">
            function <span class="apidocSignatureSpan">cluster-service.shutdown.</span>more
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.start">module cluster-service.start</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.start.start">
            function <span class="apidocSignatureSpan">cluster-service.</span>start
            <span class="apidocSignatureSpan">(options, masterCb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.start.prepArgs">
            function <span class="apidocSignatureSpan">cluster-service.start.</span>prepArgs
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.upgrade">module cluster-service.upgrade</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.upgrade.upgrade">
            function <span class="apidocSignatureSpan">cluster-service.</span>upgrade
            <span class="apidocSignatureSpan">(evt, cb, cmd, workerPath, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.upgrade.more">
            function <span class="apidocSignatureSpan">cluster-service.upgrade.</span>more
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.util">module cluster-service.util</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.util.debug">
            function <span class="apidocSignatureSpan">cluster-service.util.</span>debug
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.util.error">
            function <span class="apidocSignatureSpan">cluster-service.util.</span>error
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.util.getArgsFromQuestion">
            function <span class="apidocSignatureSpan">cluster-service.util.</span>getArgsFromQuestion
            <span class="apidocSignatureSpan">(question, delimiter)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.util.log">
            function <span class="apidocSignatureSpan">cluster-service.util.</span>log
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.util.processSafeSend">
            function <span class="apidocSignatureSpan">cluster-service.util.</span>processSafeSend
            <span class="apidocSignatureSpan">(process, msg)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.util.results">
            function <span class="apidocSignatureSpan">cluster-service.util.</span>results
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.version">module cluster-service.version</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.version.version">
            function <span class="apidocSignatureSpan">cluster-service.</span>version
            <span class="apidocSignatureSpan">(evt, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.version.more">
            function <span class="apidocSignatureSpan">cluster-service.version.</span>more
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.workerExit">module cluster-service.workerExit</a><ol>

        <li>

            <span class="apidocSignatureSpan">boolean <span class="apidocSignatureSpan">cluster-service.workerExit.</span>visible</span>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.workerExit.workerExit">
            function <span class="apidocSignatureSpan">cluster-service.</span>workerExit
            <span class="apidocSignatureSpan">(evt, cb, worker, reason)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.workerExit.control">
            function <span class="apidocSignatureSpan">cluster-service.workerExit.</span>control
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.workerStart">module cluster-service.workerStart</a><ol>

        <li>

            <span class="apidocSignatureSpan">boolean <span class="apidocSignatureSpan">cluster-service.workerStart.</span>visible</span>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.workerStart.workerStart">
            function <span class="apidocSignatureSpan">cluster-service.</span>workerStart
            <span class="apidocSignatureSpan">(evt, cb, worker, reason)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.workerStart.control">
            function <span class="apidocSignatureSpan">cluster-service.workerStart.</span>control
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.cluster-service.workers">module cluster-service.workers</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.workers.demote">
            function <span class="apidocSignatureSpan">cluster-service.workers.</span>demote
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.workers.exitGracefully">
            function <span class="apidocSignatureSpan">cluster-service.workers.</span>exitGracefully
            <span class="apidocSignatureSpan">(worker)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.workers.get">
            function <span class="apidocSignatureSpan">cluster-service.workers.</span>get
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.workers.getByPID">
            function <span class="apidocSignatureSpan">cluster-service.workers.</span>getByPID
            <span class="apidocSignatureSpan">(pid)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.workers.getByPIDFromCache">
            function <span class="apidocSignatureSpan">cluster-service.workers.</span>getByPIDFromCache
            <span class="apidocSignatureSpan">(pid)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.cluster-service.workers.monitor">
            function <span class="apidocSignatureSpan">cluster-service.workers.</span>monitor
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service" id="apidoc.module.cluster-service">module cluster-service</a></h1>


    <h2>
        <a href="#apidoc.element.cluster-service.control" id="apidoc.element.cluster-service.control">
        function <span class="apidocSignatureSpan">cluster-service.</span>control
        <span class="apidocSignatureSpan">(controls)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function addControls(controls) {
  var control;
  for (control in controls) {
    if (levels[controls[control]] === undefined) {
      throw(controls[control] + &#x22; is not a valid control level.&#x22;);
    }
    _controls[control] = levels[controls[control]];
  }
  return _controls;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
};
```

Or may be overriden at runtime via:

```javascript
// server.js
require(&#x22;cluster-service&#x22;).<span class="apidocCodeKeywordSpan">control</span>({ &#x22;exit&#x22;: &#x22;local&#x22; });
```

## Proxy Support

Proxy mode specifically caters to Web Servers that you want to enable automatic
versioning of your service. Any version requested (via `versionHeader`) that is
not yet loaded will automatically have a worker process spun up with the new
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.debug" id="apidoc.element.cluster-service.debug">
        function <span class="apidocSignatureSpan">cluster-service.</span>debug
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function debug() {
  var args;
  var i;
  if (cservice.options.cli === true &#x26;&#x26; cservice.options.debug) {
    if(process.stdout.clearLine){
      process.stdout.clearLine();
    }
    if(process.stdout.cursorTo){
      process.stdout.cursorTo(0);
    }

    args = Array.prototype.slice.call(arguments);
    for (i = 0; i &#x3c; args.length; i++) {
      if (typeof args[i] === &#x22;string&#x22;) {
        args[i] = args[i].debug;
      }
    }
    if (args.length &#x3e; 0 &#x26;&#x26; typeof args[0] === &#x22;string&#x22; &#x26;&#x26; args[0][0] === &#x22;{&#x22;) {
      cservice.options.debug(&#x22;cservice:&#x22;.cservice);
    } else {
      args = [&#x22;cservice: &#x22;.cservice].concat(args);
    }
    cservice.options.debug.apply(this, args);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    args = Array.prototype.slice.call(arguments);
    for (i = 0; i &#x3c; args.length; i++) {
      if (typeof args[i] === &#x22;string&#x22;) {
        args[i] = args[i].debug;
      }
    }
    if (args.length &#x3e; 0 &#x26;&#x26; typeof args[0] === &#x22;string&#x22; &#x26;&#x26; args[0][0] === &#x22;{&#x22;) {
      cservice.options.<span class="apidocCodeKeywordSpan">debug</span>(&#x22;cservice:&#x22;.cservice);
    } else {
      args = [&#x22;cservice: &#x22;.cservice].concat(args);
    }
    cservice.options.debug.apply(this, args);
  }
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.error" id="apidoc.element.cluster-service.error">
        function <span class="apidocSignatureSpan">cluster-service.</span>error
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function error() {
  var args;
  var i;
  if (cservice.options.cli === true &#x26;&#x26; cservice.options.error) {
    if(process.stdout.clearLine){
      process.stdout.clearLine();
    }
    if(process.stdout.cursorTo){
      process.stdout.cursorTo(0);
    }

    args = Array.prototype.slice.call(arguments);
    for (i = 0; i &#x3c; args.length; i++) {
      if (typeof args[i] === &#x22;string&#x22;) {
        args[i] = args[i].error;
      }
    }
    if (args.length &#x3e; 0 &#x26;&#x26; typeof args[0] === &#x22;string&#x22; &#x26;&#x26; args[0][0] === &#x22;{&#x22;) {
      cservice.options.error(&#x22;cservice:&#x22;.cservice);
    } else {
      args = [&#x22;cservice: &#x22;.cservice].concat(args);
    }
    cservice.options.error.apply(this, args);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  process.stdin.pause();
} catch (ex) {
}
};

function onCommand(question) {
if (cservice.locals.isBusy === true) {
  cservice.<span class="apidocCodeKeywordSpan">error</span>(&#x22;Busy... Try again after previous command returns.&#x22;);
  return;
}

cservice.locals.isBusy = true;

var args;
question = question.replace(/[\r\n]/g, &#x22;&#x22;);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.exit" id="apidoc.element.cluster-service.exit">
        function <span class="apidocSignatureSpan">cluster-service.</span>exit
        <span class="apidocSignatureSpan">(evt, cb, cmd)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">exit = function (evt, cb, cmd) {
  if (cmd !== &#x22;now&#x22;) {
    cb(&#x22;Invalid request, &#x27;now&#x27; required. Try help exit&#x22;);
    return;
  }

  cservice.log(&#x22;*** FORCEFUL TERMINATION REQUESTED ***&#x22;.warn);
  cservice.log(&#x22;Exiting now.&#x22;.warn);
  cb(null, &#x22;Exiting now.&#x22;);
  setTimeout(function() {
    process.exit(0); // exit master
  }, 100);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

Additionally, a worker may optionally perform cleanup tasks prior to exit, via:

	// worker.js
	require(&#x22;cluster-service&#x22;).workerReady({
		onWorkerStop: function() {
			// lets clean this place up
			process.<span class="apidocCodeKeywordSpan">exit</span>(); // we&#x27;re responsible for exiting if we register this cb
		}
	});



## Access Control
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.health" id="apidoc.element.cluster-service.health">
        function <span class="apidocSignatureSpan">cluster-service.</span>health
        <span class="apidocSignatureSpan">(evt, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">health = function (evt, cb) {
  cb(null, &#x22;OK&#x22;);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.help" id="apidoc.element.cluster-service.help">
        function <span class="apidocSignatureSpan">cluster-service.</span>help
        <span class="apidocSignatureSpan">(evt, cb, cmdName)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">help = function (evt, cb, cmdName) {
  var evtName, cmd, ret = {};
  if (typeof cmdName === &#x22;string&#x22;) {
    ret.command = cmdName;
    cmd = evt.locals.events[cmdName];
    if (!cmd) {
      ret.err = &#x22;Command not found&#x22;;
    } else {
      if (typeof cmd.cb.more === &#x22;function&#x22;) {
        cmd.cb.more(function(err, result) {
          cb(null, result);
        });
        return;
      } else {
        ret.more = &#x22;No additional details found.&#x22;;
      }
    }
  } else { // full listing
    ret.more = &#x22;Commands (Use &#x27;help [command_name]&#x27; for more details)&#x22;;
    ret.commands = [];
    for (evtName in evt.locals.events) {
      cmd = evt.locals.events[evtName];
      if (cmd.cb.visible === false)
        continue;
      ret.commands.push(evtName);
    }
  }

  cb(null, ret);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.info" id="apidoc.element.cluster-service.info">
        function <span class="apidocSignatureSpan">cluster-service.</span>info
        <span class="apidocSignatureSpan">(evt, cb, cmd)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">info = function (evt, cb, cmd) {
  cservice.trigger(&#x22;workers&#x22;, function(err, results) {
    if (err) {
      cb(err);
      return;
    }

    var workers = results.workers;
    var summary = {
      workers: { active: workers.length },
      memory: { rss: 0, heapTotal: 0, heapUsed: 0 },
      net: {
        connections: 0,
        connectionsOpen: 0,
        requests: 0,
        avgRequests: 0,
        avgConnections: 0
      }
    };

    for (var i = 0; i &#x3c; workers.length; i++) {
      var w = workers[i];
      var p = w.process;
      summary.memory.rss += p.memory.rss;
      summary.memory.heapTotal += p.memory.heapTotal;
      summary.memory.heapUsed += p.memory.heapUsed;
      if (p.net) {
        summary.net.connections += p.net.connections;
        summary.net.connectionsOpen += p.net.connectionsOpen;
        summary.net.requests += p.net.requests;
        summary.net.avgRequests += p.net.avgRequests;
        summary.net.avgConnections += p.net.avgConnections;
      }
    }

    cb(null, summary);
  }, &#x22;simple&#x22;);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
      options = {};
      if (arguments[4]) {
        options.workerCount = parseInt(arguments[4]);
      }
      cservice.proxy.promote(versionStr, options, cb);
      break;
    case &#x22;info&#x22;:
      cservice.proxy.<span class="apidocCodeKeywordSpan">info</span>(cb);
      break;
    default:
      cb(&#x22;Proxy command &#x22; + cmd +
        &#x22; not recognized. Try &#x27;help proxy&#x27; for more info.&#x22;);
      break;
  }
};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.locals" id="apidoc.element.cluster-service.locals">
        function <span class="apidocSignatureSpan">cluster-service.</span>locals
        <span class="apidocSignatureSpan">(evt, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">locals = function (evt, cb) {
  cb(null, cservice.locals);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.log" id="apidoc.element.cluster-service.log">
        function <span class="apidocSignatureSpan">cluster-service.</span>log
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function log() {
  var args;
  if (cservice.options.cli === true &#x26;&#x26; cservice.options.log) {
    if(process.stdout.clearLine){
      process.stdout.clearLine();
    }
    if(process.stdout.cursorTo){
      process.stdout.cursorTo(0);
    }

    args = Array.prototype.slice.call(arguments);
    if (args.length &#x3e; 0 &#x26;&#x26; typeof args[0] === &#x22;string&#x22; &#x26;&#x26; args[0][0] === &#x22;{&#x22;) {
      cservice.options.log(&#x22;cservice:&#x22;.cservice);
    } else {
      args = [&#x22;cservice: &#x22;.cservice].concat(args);
    }
    cservice.options.log.apply(this, args);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...


## Getting Started

Your existing application, be it console app or service of some kind:

	// server.js
	console.<span class="apidocCodeKeywordSpan">log</span>(&#x22;Hello World&#x22;);

Leveraging ```cluster-service``` without adding a line of code:

	npm install -g cluster-service
	cservice &#x22;server.js&#x22; --accessKey &#x22;lksjdf982734&#x22;
	// cserviced &#x22;server.js&#x22; --accessKey &#x22;lksjdf982734&#x22; // daemon
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.netStats" id="apidoc.element.cluster-service.netStats">
        function <span class="apidocSignatureSpan">cluster-service.</span>netStats
        <span class="apidocSignatureSpan">(server)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function netStats(server) {
  if (monitoring === false) {
    monitoring = true;
    monitor(); // init monitor
  }

  server.on(&#x22;connection&#x22;, function(connection) {
    net.connections++;
    net.connectionsOpen++;
    connection.on(&#x22;close&#x22;, function() {
      net.connectionsOpen--;
    });
  });

  server.on(&#x22;request&#x22;, function() {
    net.requests++;
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.newWorker" id="apidoc.element.cluster-service.newWorker">
        function <span class="apidocSignatureSpan">cluster-service.</span>newWorker
        <span class="apidocSignatureSpan">(options, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function newWorker(options, cb) {
  var worker;
  options = util._extend(util._extend({}, {
    worker: &#x22;./worker.js&#x22;,
    count: undefined,
    restart: true,
    type: &#x27;user&#x27;,
    version: undefined,
    cwd: undefined,
    onStop: false
  }), options);
  options.ready = false;
  if (
    options.worker.indexOf(&#x22;.&#x22;) === 0
    || (options.worker.indexOf(&#x22;//&#x22;) !== 0
    &#x26;&#x26; options.worker.indexOf(&#x22;:\\&#x22;) &#x3c; 0)
  ) {
    // resolve if not absolute
    options.worker = path.resolve(options.worker);
  }
  if (
    fs.existsSync(options.worker) === false
    &#x26;&#x26; fs.existsSync(options.worker + &#x22;.js&#x22;) === false
  ) {
    if(cb){
      cb(
        &#x22;Worker not found: &#x27;&#x22;
        + options.worker
        + &#x22;&#x27;. Set &#x27;workers&#x27; option to proper path.&#x22;
      );
    }
    return null;
  }
  options.cwd = options.cwd || process.cwd();
  options.onReady = cb;

  var version;
  if (options.version) {
    // track workers with version
    version = cservice.locals.proxy.versions[options.version];
    if (!version) {
      version = {
        name: options.version,
        port: options.PROXY_PORT,
        lastAccess: Date.now(),
        online: false
      };
      cservice.locals.proxy.versions[options.version] = version;
    }
  }

  worker = cluster.fork(options);
  worker.cservice = options;
  worker.on(&#x22;message&#x22;, onMessageFromWorker);

  // track every worker by pid
  cservice.locals.workerProcesses[worker.process.pid] = worker;

  return worker;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  if (
    !(cservice.locals.reason || worker.cservice.reason)
    &#x26;&#x26; worker.suicide !== true
    &#x26;&#x26; cservice.locals.restartOnFailure === true
  ) {
    setTimeout(function() {
      // lets replace lost worker.
      cservice.<span class="apidocCodeKeywordSpan">newWorker</span>(worker.cservice);
    }, options.restartDelayMs);
  }
});

// start monitor
monitorWorkers();
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.on" id="apidoc.element.cluster-service.on">
        function <span class="apidocSignatureSpan">cluster-service.</span>on
        <span class="apidocSignatureSpan">(eventName, cb, overwriteExisting)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function on(eventName, cb, overwriteExisting) {
  var evt;
  var controls;
  if (cluster.isMaster === false) {
    // no action to take on workers -- convenience feature as to not
    // pollute master code
    return;
  }

  overwriteExisting = overwriteExisting || true;
  if (!overwriteExisting &#x26;&#x26; eventName in cservice.locals.events) {
    return; // do not overwrite existing
  }

  evt = {
    name: eventName,
    service: cservice,
    locals: cservice.locals,
    cb: cb
  };

  // Adding control for this eventName
  if (typeof cb.control === &#x22;function&#x22;) {
    controls = {};
    controls[eventName] = cb.control();
    require(&#x22;./control&#x22;).addControls(controls);
  }

  // overwrite existing, if any
  cservice.locals.events[eventName] = evt;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
Creating custom, or overriding commands and events is as simple as:

  cservice &#x22;server.js&#x22; --commands &#x22;./commands,../some_more_commands&#x22;

Or if you prefer to manually do so via code:

	var cservice = require(&#x22;cluster-service&#x22;);
	cservice.<span class="apidocCodeKeywordSpan">on</span>(&#x22;custom&#x22;, function(evt, cb, arg1, arg2) { // &#x22;custom&#x22
; command
		// can also fire custom events
		cservice.trigger(&#x22;on.custom.complete&#x22;, 1, 2, 3);
	};

	cservice.on(&#x22;test&#x22;, function(evt, cb, testScript, timeout) { // we&#x27;re overriding the &#x22;test&#x22; command
		// arguments
		// do something, no callback required (events may optionally be triggered)
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.options" id="apidoc.element.cluster-service.options">
        function <span class="apidocSignatureSpan">cluster-service.</span>options
        <span class="apidocSignatureSpan">(evt, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">options = function (evt, cb) {
  cb(null, cservice.locals);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.processSafeSend" id="apidoc.element.cluster-service.processSafeSend">
        function <span class="apidocSignatureSpan">cluster-service.</span>processSafeSend
        <span class="apidocSignatureSpan">(process, msg)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function processSafeSend(process, msg) {
  try {
    process.send(msg);
  } catch (ex) {
    return ex;
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  process.on(&#x22;message&#x22;, function(msg) {
    if (!cservice.msgBus.isValidMessage(msg)) {
      return; // ignore
    }

    switch (msg.cservice.cmd) {
      case &#x22;netStats&#x22;:
        cservice.<span class="apidocCodeKeywordSpan">processSafeSend</span>(process,
          cservice.msgBus.createMessage(&#x22;netStats&#x22;, {
            netStats: net
        }));
        break;
    }
  });
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.registerCommands" id="apidoc.element.cluster-service.registerCommands">
        function <span class="apidocSignatureSpan">cluster-service.</span>registerCommands
        <span class="apidocSignatureSpan">(commands, overwriteExisting)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function register(commands, overwriteExisting) {
  if (typeof commands === &#x22;string&#x22;) {
    commands = commands.split(&#x22;,&#x22;);
  } else if (typeof commands !== &#x22;object&#x22;) {
    throw new Error(&#x22;Option &#x27;commands&#x27; must be a comma-delimited &#x22; +
      &#x22;string or an array of strings.&#x22;);
  }

  for (var i = 0; i &#x3c; commands.length; i++) {
    var dir = commands[i];
    if (dir.indexOf(&#x22;:\\&#x22;) !== 1 &#x26;&#x26; dir.indexOf(&#x22;/&#x22;) !== 0) {
      // if not absolute, resolve path from cwd
      dir = path.resolve(process.cwd(), dir);
    }

    var files = fs.readdirSync(dir);
    for (var f = 0; f &#x3c; files.length; f++) {
      var fn = path.resolve(dir, files[f]);
      var ext = path.extname(fn);
      if (ext !== &#x22;.js&#x22;)
        continue; // only js files permitted
      var basename = path.basename(fn, &#x22;.js&#x22;);
      var mod = require(fn); // load command module
      if (typeof mod.id === &#x22;string&#x22;) {
        basename = mod.id; // use module id if available
      }
      on(basename, mod, overwriteExisting);
    }
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.restart" id="apidoc.element.cluster-service.restart">
        function <span class="apidocSignatureSpan">cluster-service.</span>restart
        <span class="apidocSignatureSpan">(evt, cb, cmd, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">restart = function (evt, cb, cmd, options) {
  var pid = parseInt(cmd),
      originalAutoRestart,
      tasks;
  options = options || {};
  options.timeout = parseInt(options.timeout) || 60000;
  if (cmd !== &#x22;all&#x22; &#x26;&#x26; !pid) {
    cb(&#x22;Invalid request. Try help restart&#x22;);
    return;
  }

  evt.locals.reason = &#x22;restart&#x22;;
  originalAutoRestart = evt.locals.restartOnFailure;
  evt.locals.restartOnFailure = false;

  tasks = [];

  evt.service.workers.forEach(function(worker){
    if (pid &#x26;&#x26; worker.process.pid !== pid) {
      return; // cannot kill external processes
    }

    tasks.push(getTask(evt, worker, options, (pid ? true : false)));
  });

  if (tasks.length === 0) {
    cb(&#x22;No workers to restart&#x22;);
  } else {
    cservice.log(
      &#x22;Restarting workers... timeout: &#x22;.warn + options.timeout.toString().info
    );

    var limit = 1 +
        Math.floor(
            tasks.length * cservice.options.restartConcurrencyRatio
        );
    async.parallelLimit(tasks, limit, function(err) {
      evt.locals.restartOnFailure = originalAutoRestart; // restore

      if (err) {
        cb(err);
      } else {
        cb(null, tasks.length + &#x22; workers restarted successfully&#x22;);
      }
    });
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.results" id="apidoc.element.cluster-service.results">
        function <span class="apidocSignatureSpan">cluster-service.</span>results
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function results() {
  if(cservice.options.log){
    cservice.options.log.apply(this, arguments);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    body.indexOf(&#x22;{&#x22;) === 0
    || body.indexOf(&#x22;[&#x22;) === 0
    )
  ) {
  body = JSON.parse(body); // deserialize
}
if (options.json === true) {
  cservice.<span class="apidocCodeKeywordSpan">results</span>(JSON.stringify(body));
} else {
  cservice.results(util.inspect(body, {depth: null, colors: true}));
}

if (cb) {
  cb(err, body);
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.shutdown" id="apidoc.element.cluster-service.shutdown">
        function <span class="apidocSignatureSpan">cluster-service.</span>shutdown
        <span class="apidocSignatureSpan">(evt, cb, cmd, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">shutdown = function (evt, cb, cmd, options) {
  var pid = parseInt(cmd);
  var workersToKill;
  var exiting;

  options = options || {};
  options.timeout = parseInt(options.timeout) || 60000;
  if (cmd !== &#x22;all&#x22; &#x26;&#x26; !pid) {
    cb(&#x22;Invalid request. Try help shutdown&#x22;);
    return;
  }

  evt.locals.reason = &#x22;shutdown&#x22;;

  workersToKill = 0;

  exiting = false;
  evt.service.workers.forEach(function(worker){
    if (pid &#x26;&#x26; worker.process.pid !== pid) {
      return; // cannot kill external processes
    }

    exiting = true;
    workersToKill++;

    var killTimeout = options.timeout &#x3e; 0
      ? setTimeout(getKiller(worker), options.timeout)
      : null;
    worker.on(&#x22;exit&#x22;, getExitHandler(evt, worker, killTimeout, function() {
      workersToKill--;
      if (workersToKill === 0) {
        // no workers remain
        if (evt.service.workers.length === 0) {
          evt.locals.reason = &#x22;kill&#x22;;
          cservice.log(&#x22;All workers shutdown. Exiting...&#x22;.warn);
          evt.service.stop(options.timeout, cb);
        } else {
          cb(null, &#x22;Worker shutdown&#x22;); // DONE
        }
      }
    }));

    require(&#x22;../workers&#x22;).exitGracefully(worker);
  });

  if (exiting === false) {
    if (evt.service.workers.length === 0) {
      evt.locals.reason = &#x22;kill&#x22;;
      cservice.log(&#x22;All workers shutdown. Exiting...&#x22;);
      evt.service.stop(options.timeout, cb);
    } else {
      cb(&#x22;No workers were shutdown&#x22;);
    }
  } else {
    cservice.log(
      &#x22;Killing workers... timeout: &#x22;.warn +
      (options.timeout || 0).toString().info
    );
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.start" id="apidoc.element.cluster-service.start">
        function <span class="apidocSignatureSpan">cluster-service.</span>start
        <span class="apidocSignatureSpan">(options, masterCb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function start(options, masterCb) {
  var argv;
  if (cluster.isWorker === true) {
    // ignore starts if not master. do NOT invoke masterCb, as that is
    // reserved for master callback

    return;
  }

  if (arguments.length === 0) {
    argv = require(&#x22;optimist&#x22;).argv;

    options = argv; // use command-line arguments instead
    if (!(&#x22;cli&#x22; in options)) {
      options.cli = true; // auto-enable cli if run from command-line
    }
    prepArgs(options);
    masterCb = masterCallback;
  }

  options = options || {};
  if (&#x22;config&#x22; in options) {
    // only extend with config, do not overwrite command-line options
    var fileOptions = JSON.parse(fs.readFileSync(options.config));
    options = util._extend(fileOptions, options);
  }
  cservice.locals.options = util._extend(cservice.locals.options, options);
  if (&#x22;workers&#x22; in options) { // overwrite workers if provided
    cservice.locals.options.workers = options.workers;
  }
  options = cservice.locals.options;
  if (typeof options.workers === &#x22;string&#x22;) {
    options.workers = {
      main: {
        worker: options.workers
      }
    };
  }
  if (options.commands) {
    cservice.registerCommands(options.commands);
  }

  colors.setTheme(options.colors);

  require(&#x22;./legacy&#x22;);

  if (options.run) {
    require(&#x22;./run&#x22;).start(options, function(err, result) {
      if (masterCb &#x26;&#x26; masterCb(err, result) === false) {
        return; // do not exit if cb returns false
      }
      process.exit(0); // graceful exit
    });
  } else {
    require(&#x22;./master&#x22;).start(options, masterCb);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
Now we can leverage ```npm``` to find our local install of ```cluster-service```:

	npm start

Or, if you prefer to control ```cluster-service``` within your code, we&#x27;ve got you covered:

	// server.js
	require(&#x22;cluster-service&#x22;).<span class="apidocCodeKeywordSpan">start</span>({ workers: &#x22;./worker.js&#x22;, accessKey
: &#x22;lksjdf982734&#x22; });

	// worker.js
	console.log(&#x22;Hello World&#x22;); // notice we moved our original app logic to the worker



## Talk to it
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.stop" id="apidoc.element.cluster-service.stop">
        function <span class="apidocSignatureSpan">cluster-service.</span>stop
        <span class="apidocSignatureSpan">(timeout, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function stop(timeout, cb) {
  if (cservice.locals.state === 0) {
    if (cb) cb(null, &#x22;Not running&#x22;);
    return;
  }

  if (cservice.workers.length &#x3e; 0) { // issue shutdown
    cservice.trigger(&#x22;shutdown&#x22;, function() {
      handleWorkersExited(cb);
    }, &#x22;all&#x22;, timeout);
  } else { // gracefully shutdown
    handleWorkersExited(cb);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
module.exports = function(evt, cb, cmd) {
var versionStr, options;
switch (cmd) {
  case &#x22;start&#x22;:
    cservice.proxy.start({ configPath: arguments[3] }, cb);
    break;
  case &#x22;stop&#x22;:
    cservice.proxy.<span class="apidocCodeKeywordSpan">stop</span>(cb);
    break;
  case &#x22;version&#x22;:
    versionStr = arguments[3];
    options = {};
    if (arguments[4]) {
      options.workerCount = parseInt(arguments[4]);
    }
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.trigger" id="apidoc.element.cluster-service.trigger">
        function <span class="apidocSignatureSpan">cluster-service.</span>trigger
        <span class="apidocSignatureSpan">(eventName, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function trigger(eventName, cb) {
  var args = Array.prototype.slice.call(arguments);
  if (cservice.isWorker === true) {
    args.splice(1, 1); // remove cb from args if it exists
    cservice.msgBus.sendMessage(&#x22;trigger&#x22;, { args: args, cb: true },
      null, function(err, result) {
      // wait for response from master
      if (typeof cb === &#x22;function&#x22;) {
        cb(err, result);
      }
    });
    return;
  }
  var evt = cservice.locals.events[eventName];
  var i;
  if (!evt) {
    // invoke callback if provided instead of throwing
    if (typeof cb === &#x22;function&#x22;) {
      cb(&#x22;Event &#x22; + eventName + &#x22; not found&#x22;);
    } else {
      throw new Error(&#x22;Event &#x22; + eventName + &#x22; not found&#x22;);
    }
  }

  args.splice(0, 1, evt);

  if (typeof cb !== &#x22;function&#x22;) {
    // auto-inject dummy callback if not provided
    args.splice(1, 0, function DummyCallback(err, results) {
      // do nothing
    });
  }

  // invoke event callback
  return evt.cb.apply(null, args);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  cservice &#x22;server.js&#x22; --commands &#x22;./commands,../some_more_commands&#x22;

Or if you prefer to manually do so via code:

	var cservice = require(&#x22;cluster-service&#x22;);
	cservice.on(&#x22;custom&#x22;, function(evt, cb, arg1, arg2) { // &#x22;custom&#x22; command
		// can also fire custom events
		cservice.<span class="apidocCodeKeywordSpan">trigger</span>(&#x22;on.custom.complete&#x22;, 1, 2, 3);
	};

	cservice.on(&#x22;test&#x22;, function(evt, cb, testScript, timeout) { // we&#x27;re overriding the &#x22;test&#x22; command
		// arguments
		// do something, no callback required (events may optionally be triggered)
	};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.upgrade" id="apidoc.element.cluster-service.upgrade">
        function <span class="apidocSignatureSpan">cluster-service.</span>upgrade
        <span class="apidocSignatureSpan">(evt, cb, cmd, workerPath, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">upgrade = function (evt, cb, cmd, workerPath, options) {
  var pid = parseInt(cmd);
  var originalAutoRestart;
  var tasks;
  var workerOptions;

  options = options || {};
  options.timeout = parseInt(options.timeout) || 60000;
  options.worker = workerPath;
  if (typeof workerPath !== &#x22;string&#x22; || (cmd !== &#x22;all&#x22; &#x26;&#x26; !pid)) {
    cb(&#x22;Invalid request. Try help upgrade&#x22;);
    return;
  }

  evt.locals.reason = &#x22;upgrade&#x22;;
  originalAutoRestart = evt.locals.restartOnFailure;
  evt.locals.restartOnFailure = false;

  tasks = [];

  evt.service.workers.forEach(function(worker){
    if (pid &#x26;&#x26; worker.process.pid !== pid) {
      return; // cannot kill external processes
    }

    // use original worker options as default, by overwrite using new options
    workerOptions = util._extend(util._extend({}, worker.cservice), options);

    tasks.push(getTask(evt, worker, workerOptions));
  });

  if (tasks.length === 0) {
    cb(&#x22;No workers to upgrade&#x22;);
  } else {
    cservice.log(&#x22;Upgrading workers... timeout: &#x22; + (options.timeout || 0));

    var limit = 1 +
        Math.floor(
            tasks.length * cservice.options.restartConcurrencyRatio
        );
    async.parallelLimit(tasks, limit, function(err) {
      evt.locals.restartOnFailure = originalAutoRestart;

      if (err) {
        cb(err);
      } else {
        cb(null, tasks.length + &#x22; workers upgraded successfully&#x22;);
      }
    });
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.version" id="apidoc.element.cluster-service.version">
        function <span class="apidocSignatureSpan">cluster-service.</span>version
        <span class="apidocSignatureSpan">(evt, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">version = function (evt, cb) {
  var pkg = require(&#x22;../../package.json&#x22;);
  cb(null, pkg.version);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  break;
case &#x22;version&#x22;:
  versionStr = arguments[3];
  options = {};
  if (arguments[4]) {
    options.workerCount = parseInt(arguments[4]);
  }
  cservice.proxy.<span class="apidocCodeKeywordSpan">version</span>(versionStr, options, cb);
  break;
case &#x22;promote&#x22;:
  versionStr = arguments[3];
  options = {};
  if (arguments[4]) {
    options.workerCount = parseInt(arguments[4]);
  }
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.workerExit" id="apidoc.element.cluster-service.workerExit">
        function <span class="apidocSignatureSpan">cluster-service.</span>workerExit
        <span class="apidocSignatureSpan">(evt, cb, worker, reason)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">workerExit = function (evt, cb, worker, reason) {
	cservice.log(
    (&#x22;Worker &#x22;
      + path.basename(worker.cservice.worker)
      + &#x22;(&#x22;
      + worker.process.pid
      + &#x22;) exited, reason: &#x22;
      + (reason || worker.cservice.reason ||
        cservice.locals.reason || &#x22;Unknown&#x22;)).warn
  );
  cb();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.workerReady" id="apidoc.element.cluster-service.workerReady">
        function <span class="apidocSignatureSpan">cluster-service.</span>workerReady
        <span class="apidocSignatureSpan">(options, forceIsWorker)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function workerReady(options, forceIsWorker) {
  if (cluster.isMaster === true &#x26;&#x26; forceIsWorker !== true) {
    return; // ignore if coming from master
  }

  if (cservice.locals.workerReady === true) {
    return; // ignore dup calls
  }

  if (options === false) {
    cservice.locals.workerReady = false;

    return; // do not continue
  }

  cservice.locals.workerReady = true;

  options = options || {};

  if (options.servers) {
    require(&#x22;./net-servers&#x22;).add(options.servers);
  }

  onWorkerStop = options.onWorkerStop;

  process.on(&#x22;message&#x22;, onMessageFromMaster);

  // allow worker to inform the master when ready to speed up initialization
  cservice.processSafeSend(process,
    messageBus.createMessage(&#x22;workerReady&#x22;, {
      onStop: (typeof options.onWorkerStop === &#x22;function&#x22;)
    })
  );
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
While web servers are automatically wired up and do not require async logic (as of v1.0), if
your service requires any other asynchronous initialization code before being ready, this
is how it can be done.

Have the worker inform the master once it is actually ready:

	// worker.js
	require(&#x22;cluster-service&#x22;).<span class="apidocCodeKeywordSpan">workerReady</span>(false); // we&#x27;re NOT ready!
	setTimeout(funtion() {
		// dumb example of async support
		require(&#x22;cluster-service&#x22;).workerReady(); // we&#x27;re ready!
	}, 1000);

Additionally, a worker may optionally perform cleanup tasks prior to exit, via:
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.workerStart" id="apidoc.element.cluster-service.workerStart">
        function <span class="apidocSignatureSpan">cluster-service.</span>workerStart
        <span class="apidocSignatureSpan">(evt, cb, worker, reason)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">workerStart = function (evt, cb, worker, reason) {
	cservice.log(
    (&#x22;Worker &#x22;
      + path.basename(worker.cservice.worker)
      + &#x22;(&#x22;
      + worker.process.pid
      + &#x22;) start, reason: &#x22;
      + (reason || cservice.locals.reason || &#x22;Unknown&#x22;)).success
  );
  cb();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


























</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.cli" id="apidoc.module.cluster-service.cli">module cluster-service.cli</a></h1>


    <h2>
        <a href="#apidoc.element.cluster-service.cli.close" id="apidoc.element.cluster-service.cli.close">
        function <span class="apidocSignatureSpan">cluster-service.cli.</span>close
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">close = function () {
  try {
    process.stdin.pause();
  } catch (ex) {
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

server.on(&#x22;error&#x22;, cb);
server.listen(options.port, options.host, cb);
};

exports.close = function() {
try {
  server.<span class="apidocCodeKeywordSpan">close</span>();
} catch (ex) {
}
};

function processRequest(req, res) {
var qsIdx, qs, question;
try {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.cli.init" id="apidoc.element.cluster-service.cli.init">
        function <span class="apidocSignatureSpan">cluster-service.cli.</span>init
        <span class="apidocSignatureSpan">(o)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">init = function (o) {
  options = o;

  util.inspect.styles.name = &#x22;grey&#x22;;

  cservice.log(
    &#x22;CLI is now available. Enter &#x27;help [enter]&#x27; for instructions.&#x22;.info
  );
  process.stdin.resume();
  process.stdin.setEncoding(&#x27;utf8&#x27;);

  process.stdin.on(&#x22;data&#x22;, onCommand);

  // wait momentarily before attaching CLI. allows workers a little time
  // to output as needed
  setTimeout(function() {
    process.stdout.write(&#x22;cservice&#x3e; &#x22;.cservice);
  }, 1000);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

    startListener(options, function(err) {
      var i;
      if (err) {
cservice.locals.isAttached = true;

// start the http client
require(&#x22;./http-client&#x22;).<span class="apidocCodeKeywordSpan">init</span>(options);
      } else { // we&#x27;re the single-master
cservice.locals.isAttached = false;

cluster.setupMaster({silent: (options.silent === true)});

cluster.on(&#x22;online&#x22;, function(worker) {
  cservice.trigger(&#x22;workerStart&#x22;, worker);
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.cluster_service" id="apidoc.module.cluster-service.cluster_service">module cluster-service.cluster_service</a></h1>


    <h2>
        <a href="#apidoc.element.cluster-service.cluster_service.control" id="apidoc.element.cluster-service.cluster_service.control">
        function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>control
        <span class="apidocSignatureSpan">(controls)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function addControls(controls) {
  var control;
  for (control in controls) {
    if (levels[controls[control]] === undefined) {
      throw(controls[control] + &#x22; is not a valid control level.&#x22;);
    }
    _controls[control] = levels[controls[control]];
  }
  return _controls;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
};
```

Or may be overriden at runtime via:

```javascript
// server.js
require(&#x22;cluster-service&#x22;).<span class="apidocCodeKeywordSpan">control</span>({ &#x22;exit&#x22;: &#x22;local&#x22; });
```

## Proxy Support

Proxy mode specifically caters to Web Servers that you want to enable automatic
versioning of your service. Any version requested (via `versionHeader`) that is
not yet loaded will automatically have a worker process spun up with the new
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.cluster_service.debug" id="apidoc.element.cluster-service.cluster_service.debug">
        function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>debug
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function debug() {
  var args;
  var i;
  if (cservice.options.cli === true &#x26;&#x26; cservice.options.debug) {
    if(process.stdout.clearLine){
      process.stdout.clearLine();
    }
    if(process.stdout.cursorTo){
      process.stdout.cursorTo(0);
    }

    args = Array.prototype.slice.call(arguments);
    for (i = 0; i &#x3c; args.length; i++) {
      if (typeof args[i] === &#x22;string&#x22;) {
        args[i] = args[i].debug;
      }
    }
    if (args.length &#x3e; 0 &#x26;&#x26; typeof args[0] === &#x22;string&#x22; &#x26;&#x26; args[0][0] === &#x22;{&#x22;) {
      cservice.options.debug(&#x22;cservice:&#x22;.cservice);
    } else {
      args = [&#x22;cservice: &#x22;.cservice].concat(args);
    }
    cservice.options.debug.apply(this, args);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    args = Array.prototype.slice.call(arguments);
    for (i = 0; i &#x3c; args.length; i++) {
      if (typeof args[i] === &#x22;string&#x22;) {
        args[i] = args[i].debug;
      }
    }
    if (args.length &#x3e; 0 &#x26;&#x26; typeof args[0] === &#x22;string&#x22; &#x26;&#x26; args[0][0] === &#x22;{&#x22;) {
      cservice.options.<span class="apidocCodeKeywordSpan">debug</span>(&#x22;cservice:&#x22;.cservice);
    } else {
      args = [&#x22;cservice: &#x22;.cservice].concat(args);
    }
    cservice.options.debug.apply(this, args);
  }
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.cluster_service.error" id="apidoc.element.cluster-service.cluster_service.error">
        function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>error
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function error() {
  var args;
  var i;
  if (cservice.options.cli === true &#x26;&#x26; cservice.options.error) {
    if(process.stdout.clearLine){
      process.stdout.clearLine();
    }
    if(process.stdout.cursorTo){
      process.stdout.cursorTo(0);
    }

    args = Array.prototype.slice.call(arguments);
    for (i = 0; i &#x3c; args.length; i++) {
      if (typeof args[i] === &#x22;string&#x22;) {
        args[i] = args[i].error;
      }
    }
    if (args.length &#x3e; 0 &#x26;&#x26; typeof args[0] === &#x22;string&#x22; &#x26;&#x26; args[0][0] === &#x22;{&#x22;) {
      cservice.options.error(&#x22;cservice:&#x22;.cservice);
    } else {
      args = [&#x22;cservice: &#x22;.cservice].concat(args);
    }
    cservice.options.error.apply(this, args);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  process.stdin.pause();
} catch (ex) {
}
};

function onCommand(question) {
if (cservice.locals.isBusy === true) {
  cservice.<span class="apidocCodeKeywordSpan">error</span>(&#x22;Busy... Try again after previous command returns.&#x22;);
  return;
}

cservice.locals.isBusy = true;

var args;
question = question.replace(/[\r\n]/g, &#x22;&#x22;);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.cluster_service.log" id="apidoc.element.cluster-service.cluster_service.log">
        function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>log
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function log() {
  var args;
  if (cservice.options.cli === true &#x26;&#x26; cservice.options.log) {
    if(process.stdout.clearLine){
      process.stdout.clearLine();
    }
    if(process.stdout.cursorTo){
      process.stdout.cursorTo(0);
    }

    args = Array.prototype.slice.call(arguments);
    if (args.length &#x3e; 0 &#x26;&#x26; typeof args[0] === &#x22;string&#x22; &#x26;&#x26; args[0][0] === &#x22;{&#x22;) {
      cservice.options.log(&#x22;cservice:&#x22;.cservice);
    } else {
      args = [&#x22;cservice: &#x22;.cservice].concat(args);
    }
    cservice.options.log.apply(this, args);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...


## Getting Started

Your existing application, be it console app or service of some kind:

	// server.js
	console.<span class="apidocCodeKeywordSpan">log</span>(&#x22;Hello World&#x22;);

Leveraging ```cluster-service``` without adding a line of code:

	npm install -g cluster-service
	cservice &#x22;server.js&#x22; --accessKey &#x22;lksjdf982734&#x22;
	// cserviced &#x22;server.js&#x22; --accessKey &#x22;lksjdf982734&#x22; // daemon
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.cluster_service.netStats" id="apidoc.element.cluster-service.cluster_service.netStats">
        function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>netStats
        <span class="apidocSignatureSpan">(server)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function netStats(server) {
  if (monitoring === false) {
    monitoring = true;
    monitor(); // init monitor
  }

  server.on(&#x22;connection&#x22;, function(connection) {
    net.connections++;
    net.connectionsOpen++;
    connection.on(&#x22;close&#x22;, function() {
      net.connectionsOpen--;
    });
  });

  server.on(&#x22;request&#x22;, function() {
    net.requests++;
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.cluster_service.newWorker" id="apidoc.element.cluster-service.cluster_service.newWorker">
        function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>newWorker
        <span class="apidocSignatureSpan">(options, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function newWorker(options, cb) {
  var worker;
  options = util._extend(util._extend({}, {
    worker: &#x22;./worker.js&#x22;,
    count: undefined,
    restart: true,
    type: &#x27;user&#x27;,
    version: undefined,
    cwd: undefined,
    onStop: false
  }), options);
  options.ready = false;
  if (
    options.worker.indexOf(&#x22;.&#x22;) === 0
    || (options.worker.indexOf(&#x22;//&#x22;) !== 0
    &#x26;&#x26; options.worker.indexOf(&#x22;:\\&#x22;) &#x3c; 0)
  ) {
    // resolve if not absolute
    options.worker = path.resolve(options.worker);
  }
  if (
    fs.existsSync(options.worker) === false
    &#x26;&#x26; fs.existsSync(options.worker + &#x22;.js&#x22;) === false
  ) {
    if(cb){
      cb(
        &#x22;Worker not found: &#x27;&#x22;
        + options.worker
        + &#x22;&#x27;. Set &#x27;workers&#x27; option to proper path.&#x22;
      );
    }
    return null;
  }
  options.cwd = options.cwd || process.cwd();
  options.onReady = cb;

  var version;
  if (options.version) {
    // track workers with version
    version = cservice.locals.proxy.versions[options.version];
    if (!version) {
      version = {
        name: options.version,
        port: options.PROXY_PORT,
        lastAccess: Date.now(),
        online: false
      };
      cservice.locals.proxy.versions[options.version] = version;
    }
  }

  worker = cluster.fork(options);
  worker.cservice = options;
  worker.on(&#x22;message&#x22;, onMessageFromWorker);

  // track every worker by pid
  cservice.locals.workerProcesses[worker.process.pid] = worker;

  return worker;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  if (
    !(cservice.locals.reason || worker.cservice.reason)
    &#x26;&#x26; worker.suicide !== true
    &#x26;&#x26; cservice.locals.restartOnFailure === true
  ) {
    setTimeout(function() {
      // lets replace lost worker.
      cservice.<span class="apidocCodeKeywordSpan">newWorker</span>(worker.cservice);
    }, options.restartDelayMs);
  }
});

// start monitor
monitorWorkers();
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.cluster_service.on" id="apidoc.element.cluster-service.cluster_service.on">
        function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>on
        <span class="apidocSignatureSpan">(eventName, cb, overwriteExisting)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function on(eventName, cb, overwriteExisting) {
  var evt;
  var controls;
  if (cluster.isMaster === false) {
    // no action to take on workers -- convenience feature as to not
    // pollute master code
    return;
  }

  overwriteExisting = overwriteExisting || true;
  if (!overwriteExisting &#x26;&#x26; eventName in cservice.locals.events) {
    return; // do not overwrite existing
  }

  evt = {
    name: eventName,
    service: cservice,
    locals: cservice.locals,
    cb: cb
  };

  // Adding control for this eventName
  if (typeof cb.control === &#x22;function&#x22;) {
    controls = {};
    controls[eventName] = cb.control();
    require(&#x22;./control&#x22;).addControls(controls);
  }

  // overwrite existing, if any
  cservice.locals.events[eventName] = evt;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
Creating custom, or overriding commands and events is as simple as:

  cservice &#x22;server.js&#x22; --commands &#x22;./commands,../some_more_commands&#x22;

Or if you prefer to manually do so via code:

	var cservice = require(&#x22;cluster-service&#x22;);
	cservice.<span class="apidocCodeKeywordSpan">on</span>(&#x22;custom&#x22;, function(evt, cb, arg1, arg2) { // &#x22;custom&#x22
; command
		// can also fire custom events
		cservice.trigger(&#x22;on.custom.complete&#x22;, 1, 2, 3);
	};

	cservice.on(&#x22;test&#x22;, function(evt, cb, testScript, timeout) { // we&#x27;re overriding the &#x22;test&#x22; command
		// arguments
		// do something, no callback required (events may optionally be triggered)
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.cluster_service.processSafeSend" id="apidoc.element.cluster-service.cluster_service.processSafeSend">
        function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>processSafeSend
        <span class="apidocSignatureSpan">(process, msg)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function processSafeSend(process, msg) {
  try {
    process.send(msg);
  } catch (ex) {
    return ex;
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  process.on(&#x22;message&#x22;, function(msg) {
    if (!cservice.msgBus.isValidMessage(msg)) {
      return; // ignore
    }

    switch (msg.cservice.cmd) {
      case &#x22;netStats&#x22;:
        cservice.<span class="apidocCodeKeywordSpan">processSafeSend</span>(process,
          cservice.msgBus.createMessage(&#x22;netStats&#x22;, {
            netStats: net
        }));
        break;
    }
  });
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.cluster_service.registerCommands" id="apidoc.element.cluster-service.cluster_service.registerCommands">
        function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>registerCommands
        <span class="apidocSignatureSpan">(commands, overwriteExisting)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function register(commands, overwriteExisting) {
  if (typeof commands === &#x22;string&#x22;) {
    commands = commands.split(&#x22;,&#x22;);
  } else if (typeof commands !== &#x22;object&#x22;) {
    throw new Error(&#x22;Option &#x27;commands&#x27; must be a comma-delimited &#x22; +
      &#x22;string or an array of strings.&#x22;);
  }

  for (var i = 0; i &#x3c; commands.length; i++) {
    var dir = commands[i];
    if (dir.indexOf(&#x22;:\\&#x22;) !== 1 &#x26;&#x26; dir.indexOf(&#x22;/&#x22;) !== 0) {
      // if not absolute, resolve path from cwd
      dir = path.resolve(process.cwd(), dir);
    }

    var files = fs.readdirSync(dir);
    for (var f = 0; f &#x3c; files.length; f++) {
      var fn = path.resolve(dir, files[f]);
      var ext = path.extname(fn);
      if (ext !== &#x22;.js&#x22;)
        continue; // only js files permitted
      var basename = path.basename(fn, &#x22;.js&#x22;);
      var mod = require(fn); // load command module
      if (typeof mod.id === &#x22;string&#x22;) {
        basename = mod.id; // use module id if available
      }
      on(basename, mod, overwriteExisting);
    }
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.cluster_service.results" id="apidoc.element.cluster-service.cluster_service.results">
        function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>results
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function results() {
  if(cservice.options.log){
    cservice.options.log.apply(this, arguments);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    body.indexOf(&#x22;{&#x22;) === 0
    || body.indexOf(&#x22;[&#x22;) === 0
    )
  ) {
  body = JSON.parse(body); // deserialize
}
if (options.json === true) {
  cservice.<span class="apidocCodeKeywordSpan">results</span>(JSON.stringify(body));
} else {
  cservice.results(util.inspect(body, {depth: null, colors: true}));
}

if (cb) {
  cb(err, body);
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.cluster_service.start" id="apidoc.element.cluster-service.cluster_service.start">
        function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>start
        <span class="apidocSignatureSpan">(options, masterCb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function start(options, masterCb) {
  var argv;
  if (cluster.isWorker === true) {
    // ignore starts if not master. do NOT invoke masterCb, as that is
    // reserved for master callback

    return;
  }

  if (arguments.length === 0) {
    argv = require(&#x22;optimist&#x22;).argv;

    options = argv; // use command-line arguments instead
    if (!(&#x22;cli&#x22; in options)) {
      options.cli = true; // auto-enable cli if run from command-line
    }
    prepArgs(options);
    masterCb = masterCallback;
  }

  options = options || {};
  if (&#x22;config&#x22; in options) {
    // only extend with config, do not overwrite command-line options
    var fileOptions = JSON.parse(fs.readFileSync(options.config));
    options = util._extend(fileOptions, options);
  }
  cservice.locals.options = util._extend(cservice.locals.options, options);
  if (&#x22;workers&#x22; in options) { // overwrite workers if provided
    cservice.locals.options.workers = options.workers;
  }
  options = cservice.locals.options;
  if (typeof options.workers === &#x22;string&#x22;) {
    options.workers = {
      main: {
        worker: options.workers
      }
    };
  }
  if (options.commands) {
    cservice.registerCommands(options.commands);
  }

  colors.setTheme(options.colors);

  require(&#x22;./legacy&#x22;);

  if (options.run) {
    require(&#x22;./run&#x22;).start(options, function(err, result) {
      if (masterCb &#x26;&#x26; masterCb(err, result) === false) {
        return; // do not exit if cb returns false
      }
      process.exit(0); // graceful exit
    });
  } else {
    require(&#x22;./master&#x22;).start(options, masterCb);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
Now we can leverage ```npm``` to find our local install of ```cluster-service```:

	npm start

Or, if you prefer to control ```cluster-service``` within your code, we&#x27;ve got you covered:

	// server.js
	require(&#x22;cluster-service&#x22;).<span class="apidocCodeKeywordSpan">start</span>({ workers: &#x22;./worker.js&#x22;, accessKey
: &#x22;lksjdf982734&#x22; });

	// worker.js
	console.log(&#x22;Hello World&#x22;); // notice we moved our original app logic to the worker



## Talk to it
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.cluster_service.stop" id="apidoc.element.cluster-service.cluster_service.stop">
        function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>stop
        <span class="apidocSignatureSpan">(timeout, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function stop(timeout, cb) {
  if (cservice.locals.state === 0) {
    if (cb) cb(null, &#x22;Not running&#x22;);
    return;
  }

  if (cservice.workers.length &#x3e; 0) { // issue shutdown
    cservice.trigger(&#x22;shutdown&#x22;, function() {
      handleWorkersExited(cb);
    }, &#x22;all&#x22;, timeout);
  } else { // gracefully shutdown
    handleWorkersExited(cb);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
module.exports = function(evt, cb, cmd) {
var versionStr, options;
switch (cmd) {
  case &#x22;start&#x22;:
    cservice.proxy.start({ configPath: arguments[3] }, cb);
    break;
  case &#x22;stop&#x22;:
    cservice.proxy.<span class="apidocCodeKeywordSpan">stop</span>(cb);
    break;
  case &#x22;version&#x22;:
    versionStr = arguments[3];
    options = {};
    if (arguments[4]) {
      options.workerCount = parseInt(arguments[4]);
    }
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.cluster_service.trigger" id="apidoc.element.cluster-service.cluster_service.trigger">
        function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>trigger
        <span class="apidocSignatureSpan">(eventName, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function trigger(eventName, cb) {
  var args = Array.prototype.slice.call(arguments);
  if (cservice.isWorker === true) {
    args.splice(1, 1); // remove cb from args if it exists
    cservice.msgBus.sendMessage(&#x22;trigger&#x22;, { args: args, cb: true },
      null, function(err, result) {
      // wait for response from master
      if (typeof cb === &#x22;function&#x22;) {
        cb(err, result);
      }
    });
    return;
  }
  var evt = cservice.locals.events[eventName];
  var i;
  if (!evt) {
    // invoke callback if provided instead of throwing
    if (typeof cb === &#x22;function&#x22;) {
      cb(&#x22;Event &#x22; + eventName + &#x22; not found&#x22;);
    } else {
      throw new Error(&#x22;Event &#x22; + eventName + &#x22; not found&#x22;);
    }
  }

  args.splice(0, 1, evt);

  if (typeof cb !== &#x22;function&#x22;) {
    // auto-inject dummy callback if not provided
    args.splice(1, 0, function DummyCallback(err, results) {
      // do nothing
    });
  }

  // invoke event callback
  return evt.cb.apply(null, args);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  cservice &#x22;server.js&#x22; --commands &#x22;./commands,../some_more_commands&#x22;

Or if you prefer to manually do so via code:

	var cservice = require(&#x22;cluster-service&#x22;);
	cservice.on(&#x22;custom&#x22;, function(evt, cb, arg1, arg2) { // &#x22;custom&#x22; command
		// can also fire custom events
		cservice.<span class="apidocCodeKeywordSpan">trigger</span>(&#x22;on.custom.complete&#x22;, 1, 2, 3);
	};

	cservice.on(&#x22;test&#x22;, function(evt, cb, testScript, timeout) { // we&#x27;re overriding the &#x22;test&#x22; command
		// arguments
		// do something, no callback required (events may optionally be triggered)
	};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.cluster_service.workerReady" id="apidoc.element.cluster-service.cluster_service.workerReady">
        function <span class="apidocSignatureSpan">cluster-service.cluster_service.</span>workerReady
        <span class="apidocSignatureSpan">(options, forceIsWorker)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function workerReady(options, forceIsWorker) {
  if (cluster.isMaster === true &#x26;&#x26; forceIsWorker !== true) {
    return; // ignore if coming from master
  }

  if (cservice.locals.workerReady === true) {
    return; // ignore dup calls
  }

  if (options === false) {
    cservice.locals.workerReady = false;

    return; // do not continue
  }

  cservice.locals.workerReady = true;

  options = options || {};

  if (options.servers) {
    require(&#x22;./net-servers&#x22;).add(options.servers);
  }

  onWorkerStop = options.onWorkerStop;

  process.on(&#x22;message&#x22;, onMessageFromMaster);

  // allow worker to inform the master when ready to speed up initialization
  cservice.processSafeSend(process,
    messageBus.createMessage(&#x22;workerReady&#x22;, {
      onStop: (typeof options.onWorkerStop === &#x22;function&#x22;)
    })
  );
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
While web servers are automatically wired up and do not require async logic (as of v1.0), if
your service requires any other asynchronous initialization code before being ready, this
is how it can be done.

Have the worker inform the master once it is actually ready:

	// worker.js
	require(&#x22;cluster-service&#x22;).<span class="apidocCodeKeywordSpan">workerReady</span>(false); // we&#x27;re NOT ready!
	setTimeout(funtion() {
		// dumb example of async support
		require(&#x22;cluster-service&#x22;).workerReady(); // we&#x27;re ready!
	}, 1000);

Additionally, a worker may optionally perform cleanup tasks prior to exit, via:
...</pre></li>
    </ul>








</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.commands" id="apidoc.module.cluster-service.commands">module cluster-service.commands</a></h1>


    <h2>
        <a href="#apidoc.element.cluster-service.commands.on" id="apidoc.element.cluster-service.commands.on">
        function <span class="apidocSignatureSpan">cluster-service.commands.</span>on
        <span class="apidocSignatureSpan">(eventName, cb, overwriteExisting)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function on(eventName, cb, overwriteExisting) {
  var evt;
  var controls;
  if (cluster.isMaster === false) {
    // no action to take on workers -- convenience feature as to not
    // pollute master code
    return;
  }

  overwriteExisting = overwriteExisting || true;
  if (!overwriteExisting &#x26;&#x26; eventName in cservice.locals.events) {
    return; // do not overwrite existing
  }

  evt = {
    name: eventName,
    service: cservice,
    locals: cservice.locals,
    cb: cb
  };

  // Adding control for this eventName
  if (typeof cb.control === &#x22;function&#x22;) {
    controls = {};
    controls[eventName] = cb.control();
    require(&#x22;./control&#x22;).addControls(controls);
  }

  // overwrite existing, if any
  cservice.locals.events[eventName] = evt;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
Creating custom, or overriding commands and events is as simple as:

  cservice &#x22;server.js&#x22; --commands &#x22;./commands,../some_more_commands&#x22;

Or if you prefer to manually do so via code:

	var cservice = require(&#x22;cluster-service&#x22;);
	cservice.<span class="apidocCodeKeywordSpan">on</span>(&#x22;custom&#x22;, function(evt, cb, arg1, arg2) { // &#x22;custom&#x22
; command
		// can also fire custom events
		cservice.trigger(&#x22;on.custom.complete&#x22;, 1, 2, 3);
	};

	cservice.on(&#x22;test&#x22;, function(evt, cb, testScript, timeout) { // we&#x27;re overriding the &#x22;test&#x22; command
		// arguments
		// do something, no callback required (events may optionally be triggered)
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.commands.register" id="apidoc.element.cluster-service.commands.register">
        function <span class="apidocSignatureSpan">cluster-service.commands.</span>register
        <span class="apidocSignatureSpan">(commands, overwriteExisting)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function register(commands, overwriteExisting) {
  if (typeof commands === &#x22;string&#x22;) {
    commands = commands.split(&#x22;,&#x22;);
  } else if (typeof commands !== &#x22;object&#x22;) {
    throw new Error(&#x22;Option &#x27;commands&#x27; must be a comma-delimited &#x22; +
      &#x22;string or an array of strings.&#x22;);
  }

  for (var i = 0; i &#x3c; commands.length; i++) {
    var dir = commands[i];
    if (dir.indexOf(&#x22;:\\&#x22;) !== 1 &#x26;&#x26; dir.indexOf(&#x22;/&#x22;) !== 0) {
      // if not absolute, resolve path from cwd
      dir = path.resolve(process.cwd(), dir);
    }

    var files = fs.readdirSync(dir);
    for (var f = 0; f &#x3c; files.length; f++) {
      var fn = path.resolve(dir, files[f]);
      var ext = path.extname(fn);
      if (ext !== &#x22;.js&#x22;)
        continue; // only js files permitted
      var basename = path.basename(fn, &#x22;.js&#x22;);
      var mod = require(fn); // load command module
      if (typeof mod.id === &#x22;string&#x22;) {
        basename = mod.id; // use module id if available
      }
      on(basename, mod, overwriteExisting);
    }
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.control" id="apidoc.module.cluster-service.control">module cluster-service.control</a></h1>


    <h2>
        <a href="#apidoc.element.cluster-service.control.addControls" id="apidoc.element.cluster-service.control.addControls">
        function <span class="apidocSignatureSpan">cluster-service.control.</span>addControls
        <span class="apidocSignatureSpan">(controls)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function addControls(controls) {
  var control;
  for (control in controls) {
    if (levels[controls[control]] === undefined) {
      throw(controls[control] + &#x22; is not a valid control level.&#x22;);
    }
    _controls[control] = levels[controls[control]];
  }
  return _controls;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    cb: cb
  };

  // Adding control for this eventName
  if (typeof cb.control === &#x22;function&#x22;) {
    controls = {};
    controls[eventName] = cb.control();
    require(&#x22;./control&#x22;).<span class="apidocCodeKeywordSpan">addControls</span>(controls);
  }

  // overwrite existing, if any
  cservice.locals.events[eventName] = evt;
}

function register(commands, overwriteExisting) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.control.authorize" id="apidoc.element.cluster-service.control.authorize">
        function <span class="apidocSignatureSpan">cluster-service.control.</span>authorize
        <span class="apidocSignatureSpan">(name, currentControl, accessKey)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function authorize(name, currentControl, accessKey) {
  if (typeof accessKey === &#x22;string&#x22; &#x26;&#x26; accessKey in _keys) {
    // if access key available, check rights
    var rights = _keys[accessKey];
    if (rights === false) {
      return false; // DENIED
    } else if (typeof rights === &#x22;object&#x22; &#x26;&#x26; name in rights) {
      // custom rights detected
      var commandRight = rights[name];
      if (typeof commandRight === &#x22;boolean&#x22;) {
        return commandRight; // return as is
      } else if (typeof commandRight === &#x22;string&#x22; &#x26;&#x26; commandRight in levels) {
        return currentControl &#x3e;= levels[commandRight];
      }
    }
  }

  if (_controls[name]) {
    return currentControl &#x3e;= _controls[name];
  }
  // We default to &#x22;remote&#x22; which is full access
  return currentControl &#x3e;= levels.remote;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
}

controlLevel = control.levels.remote;
if (req.connection.remoteAddress === &#x22;127.0.0.1&#x22;) {
  controlLevel = control.levels.local;
}

isAuthorized = control.<span class="apidocCodeKeywordSpan">authorize</span>(args[0], controlLevel, accessKey);

if (!isAuthorized) {
  res.writeHead(401);
  res.end(&#x22;Not authorized to execute &#x27;&#x22; + args[0] + &#x22;&#x27; remotely&#x22;);
  return;
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.control.setAccessKey" id="apidoc.element.cluster-service.control.setAccessKey">
        function <span class="apidocSignatureSpan">cluster-service.control.</span>setAccessKey
        <span class="apidocSignatureSpan">(keys)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function setAccessKey(keys) {
  _keys = {};

  var keyArr = keys.split(&#x22;;&#x22;);
  for (var i = 0; i &#x3c; keyArr.length; i++) {
    var fullKey = keyArr[i];
    var keyName = /([a-zA-Z0-9]*)?/.exec(fullKey)[0];
    var keyDisabled = /[a-zA-Z0-9]*\:disabled/.test(fullKey);
    if (keyDisabled === true) {
      _keys[keyName] = false;
      continue;
    }

    var key = { };
    var cmdList = /\[(.*)?\]/.exec(fullKey);
    if (cmdList &#x26;&#x26; cmdList.length &#x3e; 0) {
      var cmds = cmdList[1].split(&#x22;,&#x22;);
      for (var i2 = 0; i2 &#x3c; cmds.length; i2++ ){
        var fullCmd = cmds[i2];
        var cmdName = /([a-zA-Z0-9]*)?/.exec(fullCmd)[0];
        var cmdValStr = /\:(.*)?/.exec(fullCmd);
        var cmdVal = true;
        if (cmdValStr &#x26;&#x26; cmdValStr.length &#x3e; 0) {
          switch (cmdValStr[1]) {
            case &#x22;false&#x22;:
            case &#x22;disabled&#x22;:
              cmdVal = &#x22;disabled&#x22;;
              break;
            case &#x22;remote&#x22;:
              cmdVal = &#x22;remote&#x22;;
              break;
            case &#x22;local&#x22;:
              cmdVal = &#x22;local&#x22;;
              break;
            case &#x22;inproc&#x22;:
              cmdVal = &#x22;inproc&#x22;;
              break;
          }

          key[cmdName] = cmdVal;
        }
      }
    }

    _keys[keyName] = key;
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    .join(&#x27; &#x27;)
    .info
    );
  cb();
  return;
} else {
  options.accessKey = options.accessKey.toString();
  require(&#x22;./control&#x22;).<span class="apidocCodeKeywordSpan">setAccessKey</span>(options.accessKey);
}

httpserver.init(options, function(err) {
  if (!err) {
    cservice.log(
      (&#x22;Listening at &#x22;
        + (
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.control.setControls" id="apidoc.element.cluster-service.control.setControls">
        function <span class="apidocSignatureSpan">cluster-service.control.</span>setControls
        <span class="apidocSignatureSpan">(controls)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function setControls(controls) {
  _controls = {};
  return addControls(controls);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>




</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.exit" id="apidoc.module.cluster-service.exit">module cluster-service.exit</a></h1>


    <h2>
        <a href="#apidoc.element.cluster-service.exit.exit" id="apidoc.element.cluster-service.exit.exit">
        function <span class="apidocSignatureSpan">cluster-service.</span>exit
        <span class="apidocSignatureSpan">(evt, cb, cmd)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">exit = function (evt, cb, cmd) {
  if (cmd !== &#x22;now&#x22;) {
    cb(&#x22;Invalid request, &#x27;now&#x27; required. Try help exit&#x22;);
    return;
  }

  cservice.log(&#x22;*** FORCEFUL TERMINATION REQUESTED ***&#x22;.warn);
  cservice.log(&#x22;Exiting now.&#x22;.warn);
  cb(null, &#x22;Exiting now.&#x22;);
  setTimeout(function() {
    process.exit(0); // exit master
  }, 100);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

Additionally, a worker may optionally perform cleanup tasks prior to exit, via:

	// worker.js
	require(&#x22;cluster-service&#x22;).workerReady({
		onWorkerStop: function() {
			// lets clean this place up
			process.<span class="apidocCodeKeywordSpan">exit</span>(); // we&#x27;re responsible for exiting if we register this cb
		}
	});



## Access Control
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.exit.control" id="apidoc.element.cluster-service.exit.control">
        function <span class="apidocSignatureSpan">cluster-service.exit.</span>control
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">control = function () {
  return &#x22;local&#x22;;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
};
```

Or may be overriden at runtime via:

```javascript
// server.js
require(&#x22;cluster-service&#x22;).<span class="apidocCodeKeywordSpan">control</span>({ &#x22;exit&#x22;: &#x22;local&#x22; });
```

## Proxy Support

Proxy mode specifically caters to Web Servers that you want to enable automatic
versioning of your service. Any version requested (via `versionHeader`) that is
not yet loaded will automatically have a worker process spun up with the new
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.exit.more" id="apidoc.element.cluster-service.exit.more">
        function <span class="apidocSignatureSpan">cluster-service.exit.</span>more
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">more = function (cb) {
  cb(null, {
    info: &#x22;Forcefully exits the service.&#x22;,
    command: &#x22;exit now&#x22;,
    &#x22;now&#x22;: &#x22;Required. &#x27;now&#x27; to force exit.&#x22;
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  if (typeof cmdName === &#x22;string&#x22;) {
ret.command = cmdName;
cmd = evt.locals.events[cmdName];
if (!cmd) {
  ret.err = &#x22;Command not found&#x22;;
} else {
  if (typeof cmd.cb.more === &#x22;function&#x22;) {
    cmd.cb.<span class="apidocCodeKeywordSpan">more</span>(function(err, result) {
      cb(null, result);
    });
    return;
  } else {
    ret.more = &#x22;No additional details found.&#x22;;
  }
}
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.health" id="apidoc.module.cluster-service.health">module cluster-service.health</a></h1>


    <h2>
        <a href="#apidoc.element.cluster-service.health.health" id="apidoc.element.cluster-service.health.health">
        function <span class="apidocSignatureSpan">cluster-service.</span>health
        <span class="apidocSignatureSpan">(evt, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">health = function (evt, cb) {
  cb(null, &#x22;OK&#x22;);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.health.more" id="apidoc.element.cluster-service.health.more">
        function <span class="apidocSignatureSpan">cluster-service.health.</span>more
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">more = function (cb) {
  cb(null, {
    command: &#x22;health&#x22;,
    info: [
      &#x22;Returns health of service.&#x22;,
      &#x22;May be overidden by service to expose app-specific data.&#x22;
    ].join(&#x27; &#x27;)
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  if (typeof cmdName === &#x22;string&#x22;) {
ret.command = cmdName;
cmd = evt.locals.events[cmdName];
if (!cmd) {
  ret.err = &#x22;Command not found&#x22;;
} else {
  if (typeof cmd.cb.more === &#x22;function&#x22;) {
    cmd.cb.<span class="apidocCodeKeywordSpan">more</span>(function(err, result) {
      cb(null, result);
    });
    return;
  } else {
    ret.more = &#x22;No additional details found.&#x22;;
  }
}
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.help" id="apidoc.module.cluster-service.help">module cluster-service.help</a></h1>


    <h2>
        <a href="#apidoc.element.cluster-service.help.help" id="apidoc.element.cluster-service.help.help">
        function <span class="apidocSignatureSpan">cluster-service.</span>help
        <span class="apidocSignatureSpan">(evt, cb, cmdName)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">help = function (evt, cb, cmdName) {
  var evtName, cmd, ret = {};
  if (typeof cmdName === &#x22;string&#x22;) {
    ret.command = cmdName;
    cmd = evt.locals.events[cmdName];
    if (!cmd) {
      ret.err = &#x22;Command not found&#x22;;
    } else {
      if (typeof cmd.cb.more === &#x22;function&#x22;) {
        cmd.cb.more(function(err, result) {
          cb(null, result);
        });
        return;
      } else {
        ret.more = &#x22;No additional details found.&#x22;;
      }
    }
  } else { // full listing
    ret.more = &#x22;Commands (Use &#x27;help [command_name]&#x27; for more details)&#x22;;
    ret.commands = [];
    for (evtName in evt.locals.events) {
      cmd = evt.locals.events[evtName];
      if (cmd.cb.visible === false)
        continue;
      ret.commands.push(evtName);
    }
  }

  cb(null, ret);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.help.control" id="apidoc.element.cluster-service.help.control">
        function <span class="apidocSignatureSpan">cluster-service.help.</span>control
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">control = function () {
  return &#x22;local&#x22;;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
};
```

Or may be overriden at runtime via:

```javascript
// server.js
require(&#x22;cluster-service&#x22;).<span class="apidocCodeKeywordSpan">control</span>({ &#x22;exit&#x22;: &#x22;local&#x22; });
```

## Proxy Support

Proxy mode specifically caters to Web Servers that you want to enable automatic
versioning of your service. Any version requested (via `versionHeader`) that is
not yet loaded will automatically have a worker process spun up with the new
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.help.more" id="apidoc.element.cluster-service.help.more">
        function <span class="apidocSignatureSpan">cluster-service.help.</span>more
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">more = function (cb) {
  cb(null, {
    &#x22;command&#x22;: &#x22;help [command_name]&#x22;,
    &#x22;command_name&#x22;: &#x22;Optional if you want extended help&#x22;
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  if (typeof cmdName === &#x22;string&#x22;) {
ret.command = cmdName;
cmd = evt.locals.events[cmdName];
if (!cmd) {
  ret.err = &#x22;Command not found&#x22;;
} else {
  if (typeof cmd.cb.more === &#x22;function&#x22;) {
    cmd.cb.<span class="apidocCodeKeywordSpan">more</span>(function(err, result) {
      cb(null, result);
    });
    return;
  } else {
    ret.more = &#x22;No additional details found.&#x22;;
  }
}
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.http_client" id="apidoc.module.cluster-service.http_client">module cluster-service.http_client</a></h1>


    <h2>
        <a href="#apidoc.element.cluster-service.http_client.execute" id="apidoc.element.cluster-service.http_client.execute">
        function <span class="apidocSignatureSpan">cluster-service.http_client.</span>execute
        <span class="apidocSignatureSpan">(question, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function onCommand(question, cb) {
  var split, qs, url, body, err;
  question = question.replace(/[\r\n]/g, &#x22;&#x22;);
  split = question.split(&#x22; &#x22;);
  if (split[0] === &#x22;exit&#x22;) {
    cservice.log(&#x22;Exiting CLI ONLY.&#x22;.yellow);
    process.kill(process.pid, &#x22;SIGKILL&#x22;); // exit by force
    return;
  }
  qs = querystring.stringify({
    cmd: question,
    accessKey: options.accessKey
  });
  url = &#x22;http://&#x22;
    + (options.host || &#x22;localhost&#x22;)
    + &#x22;:&#x22;
    + (options.port || 11987)
    + &#x22;/cli&#x22;
    + &#x22;?&#x22;
    + qs;
  cservice.log(
    &#x22;Running remote command: &#x22;.warn
    + url.replace(/accessKey=.*/i, &#x22;accessKey={ACCESS_KEY}&#x22;).data
  );
  body = &#x22;&#x22;;
  http.request(
    {
      host: options.host || &#x22;localhost&#x22;,
      port: options.port || 11987,
      path: &#x22;/cli?&#x22; + qs,
      method: &#x22;POST&#x22;
    }
    , function(res) {
      res.setEncoding(&#x27;utf8&#x27;);
      res.on(&#x22;data&#x22;, function(chunk) {
        body += chunk;
      });
      res.on(&#x22;end&#x22;, function() {
        if (res.statusCode !== 200 &#x26;&#x26; body) {
          err = body;
        }
        onCallback(err, body, res, cb);
      });
    }
  ).on(&#x22;error&#x22;, function(err) {
      body = err;
      onCallback(err, body, null, cb);
    }
  ).end();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.http_client.init" id="apidoc.element.cluster-service.http_client.init">
        function <span class="apidocSignatureSpan">cluster-service.http_client.</span>init
        <span class="apidocSignatureSpan">(o)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">init = function (o) {
  options = o;

  cservice.log([
      &#x22;Service already running. Attached CLI to master service.&#x22;,
      &#x22;Enter &#x27;help [enter]&#x27; for help.&#x22;
    ]
    .join(&#x27; &#x27;)
    .info
  );

  if (!options || options.silentMode !== true) {
    process.stdin.resume();
    process.stdin.setEncoding(&#x27;utf8&#x27;);
    process.stdin.on(&#x22;data&#x22;, onCommand);
    process.stdout.write(&#x22;cservice&#x3e; &#x22;.cservice);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

    startListener(options, function(err) {
      var i;
      if (err) {
cservice.locals.isAttached = true;

// start the http client
require(&#x22;./http-client&#x22;).<span class="apidocCodeKeywordSpan">init</span>(options);
      } else { // we&#x27;re the single-master
cservice.locals.isAttached = false;

cluster.setupMaster({silent: (options.silent === true)});

cluster.on(&#x22;online&#x22;, function(worker) {
  cservice.trigger(&#x22;workerStart&#x22;, worker);
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.http_server" id="apidoc.module.cluster-service.http_server">module cluster-service.http_server</a></h1>


    <h2>
        <a href="#apidoc.element.cluster-service.http_server.close" id="apidoc.element.cluster-service.http_server.close">
        function <span class="apidocSignatureSpan">cluster-service.http_server.</span>close
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">close = function () {
  try {
    server.close();
  } catch (ex) {
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

server.on(&#x22;error&#x22;, cb);
server.listen(options.port, options.host, cb);
};

exports.close = function() {
try {
  server.<span class="apidocCodeKeywordSpan">close</span>();
} catch (ex) {
}
};

function processRequest(req, res) {
var qsIdx, qs, question;
try {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.http_server.init" id="apidoc.element.cluster-service.http_server.init">
        function <span class="apidocSignatureSpan">cluster-service.http_server.</span>init
        <span class="apidocSignatureSpan">(o, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">init = function (o, cb) {
  options = o;

  if (options.ssl) { // HTTPS
    server = cservice.locals.http =
      https.createServer(options.ssl, processRequest)
    ;
  } else { // HTTP
    server = cservice.locals.http =
      http.createServer(processRequest)
    ;
  }

  server.on(&#x22;error&#x22;, cb);
  server.listen(options.port, options.host, cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

    startListener(options, function(err) {
      var i;
      if (err) {
cservice.locals.isAttached = true;

// start the http client
require(&#x22;./http-client&#x22;).<span class="apidocCodeKeywordSpan">init</span>(options);
      } else { // we&#x27;re the single-master
cservice.locals.isAttached = false;

cluster.setupMaster({silent: (options.silent === true)});

cluster.on(&#x22;online&#x22;, function(worker) {
  cservice.trigger(&#x22;workerStart&#x22;, worker);
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.info" id="apidoc.module.cluster-service.info">module cluster-service.info</a></h1>


    <h2>
        <a href="#apidoc.element.cluster-service.info.info" id="apidoc.element.cluster-service.info.info">
        function <span class="apidocSignatureSpan">cluster-service.</span>info
        <span class="apidocSignatureSpan">(evt, cb, cmd)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">info = function (evt, cb, cmd) {
  cservice.trigger(&#x22;workers&#x22;, function(err, results) {
    if (err) {
      cb(err);
      return;
    }

    var workers = results.workers;
    var summary = {
      workers: { active: workers.length },
      memory: { rss: 0, heapTotal: 0, heapUsed: 0 },
      net: {
        connections: 0,
        connectionsOpen: 0,
        requests: 0,
        avgRequests: 0,
        avgConnections: 0
      }
    };

    for (var i = 0; i &#x3c; workers.length; i++) {
      var w = workers[i];
      var p = w.process;
      summary.memory.rss += p.memory.rss;
      summary.memory.heapTotal += p.memory.heapTotal;
      summary.memory.heapUsed += p.memory.heapUsed;
      if (p.net) {
        summary.net.connections += p.net.connections;
        summary.net.connectionsOpen += p.net.connectionsOpen;
        summary.net.requests += p.net.requests;
        summary.net.avgRequests += p.net.avgRequests;
        summary.net.avgConnections += p.net.avgConnections;
      }
    }

    cb(null, summary);
  }, &#x22;simple&#x22;);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
      options = {};
      if (arguments[4]) {
        options.workerCount = parseInt(arguments[4]);
      }
      cservice.proxy.promote(versionStr, options, cb);
      break;
    case &#x22;info&#x22;:
      cservice.proxy.<span class="apidocCodeKeywordSpan">info</span>(cb);
      break;
    default:
      cb(&#x22;Proxy command &#x22; + cmd +
        &#x22; not recognized. Try &#x27;help proxy&#x27; for more info.&#x22;);
      break;
  }
};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.info.control" id="apidoc.element.cluster-service.info.control">
        function <span class="apidocSignatureSpan">cluster-service.info.</span>control
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">control = function () {
  return &#x22;remote&#x22;; // consistent with &#x22;workers&#x22; command,
                   // but may be locked down in the future
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
};
```

Or may be overriden at runtime via:

```javascript
// server.js
require(&#x22;cluster-service&#x22;).<span class="apidocCodeKeywordSpan">control</span>({ &#x22;exit&#x22;: &#x22;local&#x22; });
```

## Proxy Support

Proxy mode specifically caters to Web Servers that you want to enable automatic
versioning of your service. Any version requested (via `versionHeader`) that is
not yet loaded will automatically have a worker process spun up with the new
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.info.more" id="apidoc.element.cluster-service.info.more">
        function <span class="apidocSignatureSpan">cluster-service.info.</span>more
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">more = function (cb) {
  cb(null, {
    command: &#x22;info&#x22;,
    info: &#x22;Returns summary of process &#x26; workers.&#x22;
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  if (typeof cmdName === &#x22;string&#x22;) {
ret.command = cmdName;
cmd = evt.locals.events[cmdName];
if (!cmd) {
  ret.err = &#x22;Command not found&#x22;;
} else {
  if (typeof cmd.cb.more === &#x22;function&#x22;) {
    cmd.cb.<span class="apidocCodeKeywordSpan">more</span>(function(err, result) {
      cb(null, result);
    });
    return;
  } else {
    ret.more = &#x22;No additional details found.&#x22;;
  }
}
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.locals" id="apidoc.module.cluster-service.locals">module cluster-service.locals</a></h1>




    <h2>
        <a href="#apidoc.element.cluster-service.locals.locals" id="apidoc.element.cluster-service.locals.locals">
        function <span class="apidocSignatureSpan">cluster-service.</span>locals
        <span class="apidocSignatureSpan">(evt, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">locals = function (evt, cb) {
  cb(null, cservice.locals);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.locals.control" id="apidoc.element.cluster-service.locals.control">
        function <span class="apidocSignatureSpan">cluster-service.locals.</span>control
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">control = function () {
  return &#x22;local&#x22;;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
};
```

Or may be overriden at runtime via:

```javascript
// server.js
require(&#x22;cluster-service&#x22;).<span class="apidocCodeKeywordSpan">control</span>({ &#x22;exit&#x22;: &#x22;local&#x22; });
```

## Proxy Support

Proxy mode specifically caters to Web Servers that you want to enable automatic
versioning of your service. Any version requested (via `versionHeader`) that is
not yet loaded will automatically have a worker process spun up with the new
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.locals.more" id="apidoc.element.cluster-service.locals.more">
        function <span class="apidocSignatureSpan">cluster-service.locals.</span>more
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">more = function (cb) {
  cb(null, {
    command: &#x22;locals&#x22;,
    info: &#x22;Returns locals state object for debug purposes.&#x22;
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  if (typeof cmdName === &#x22;string&#x22;) {
ret.command = cmdName;
cmd = evt.locals.events[cmdName];
if (!cmd) {
  ret.err = &#x22;Command not found&#x22;;
} else {
  if (typeof cmd.cb.more === &#x22;function&#x22;) {
    cmd.cb.<span class="apidocCodeKeywordSpan">more</span>(function(err, result) {
      cb(null, result);
    });
    return;
  } else {
    ret.more = &#x22;No additional details found.&#x22;;
  }
}
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.master" id="apidoc.module.cluster-service.master">module cluster-service.master</a></h1>


    <h2>
        <a href="#apidoc.element.cluster-service.master.start" id="apidoc.element.cluster-service.master.start">
        function <span class="apidocSignatureSpan">cluster-service.master.</span>start
        <span class="apidocSignatureSpan">(options, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function startMaster(options, cb) {
  var workersRemaining;
  var workersForked;
  var workers;
  var i;
  var workerName;
  var worker;
  var workerCount;

  options = options || {};
  options.workerCount = options.workerCount || 1;

  if (cservice.locals.state === 0) { // one-time initializers
    cservice.locals.state = 1; // starting

    require(&#x22;./commands/version&#x22;)({}, function(err, ver) {
      cservice.log(&#x22;cluster-service v&#x22;.info + ver.data + &#x22; starting...&#x22;.info);
    });

<span class="apidocCodeCommentSpan">    /*process.on(&#x22;uncaughtException&#x22;, function(err) {
     cservice.log(&#x22;uncaughtException&#x22;, util.inspect(err));
     });*/
</span>
    // queue up our request
    startRequests.push(function() {
      startMaster(options, cb);
    });

    startListener(options, function(err) {
      var i;
      if (err) {
        cservice.locals.isAttached = true;

        // start the http client
        require(&#x22;./http-client&#x22;).init(options);
      } else { // we&#x27;re the single-master
        cservice.locals.isAttached = false;

        cluster.setupMaster({silent: (options.silent === true)});

        cluster.on(&#x22;online&#x22;, function(worker) {
          cservice.trigger(&#x22;workerStart&#x22;, worker);
        });
        cluster.on(&#x22;exit&#x22;, function(worker, code, signal) {
          // stop tracking
          var version = cservice.locals.proxy.versions[worker.cservice.version];
          if (version) {
            // get all proxy workers for a specific version
            var versionWorkers =
              cservice.proxy.getVersionWorkers(worker.cservice.version);
            // exclude our exiting worker process in case it&#x27;s still returned
            versionWorkers = versionWorkers.filter(function(versionWorker) {
              return worker.process.pid !== versionWorker.process.pid;
            });

            if (versionWorkers.length === 0) {
              // if no workers remain for a given version, drop the version
              delete cservice.locals.proxy.versions[worker.cservice.version];

              // inform proxy workers of version change
              cservice.proxy.updateProxyWorkers();
            }
          }
          delete cservice.locals.workerProcesses[worker.process.pid];

          cservice.trigger(&#x22;workerExit&#x22;, worker);
          // do not restart if there is a reason, or disabled
          if (
            !(cservice.locals.reason || worker.cservice.reason)
            &#x26;&#x26; worker.suicide !== true
            &#x26;&#x26; cservice.locals.restartOnFailure === true
          ) {
            setTimeout(function() {
              // lets replace lost worker.
              cservice.newWorker(worker.cservice);
            }, options.restartDelayMs);
          }
        });

        // start monitor
        monitorWorkers();

        if (options.cli === true) {
          // wire-up CLI
          require(&#x22;./cli&#x22;).init(options);
        }
      }

      cservice.proxy.start({}, function() {
        cservice.locals.state = 2; // running

        // now that listener is ready, process queued start requests
        for (i = 0; i &#x3c; startRequests.length; i++) {
          startRequests[i](); // execute
        }
        startRequests = [];
      });
    });
  } else if (cservice.locals.state === 1) { // if still starting, queue requests
    startRequests.push(function() {
      startMaster(options, cb);
    });
  // if we&#x27;re NOT attached, we can spawn the workers now
  } else if (cservice.locals.isAttached === false) {
    // fork it, i&#x27;m out of here
    workersRemaining = 0;
    workersForked = 0;

    if (options.workers !== null) {
      workers = typeof options.workers === &#x22;string&#x22;
        ? {main: {worker: options.workers}}
        : options.workers;
      for (workerName in workers) {
        worker = workers[workerName];
        workerCount = worker.count || options.workerCount;
        workersRemaining += workerCount;
        workersForked += workerCount;
        for (i = 0; i &#x3c; workerCount; i++) {
          cservice.newWorker(worker, function(err) {
            workersRemaining--;
            if (err) {
              workersRemaining = 0; // callback now ...</pre></li>
    <li>example usage<pre class="apidocCodePre">...
Now we can leverage ```npm``` to find our local install of ```cluster-service```:

	npm start

Or, if you prefer to control ```cluster-service``` within your code, we&#x27;ve got you covered:

	// server.js
	require(&#x22;cluster-service&#x22;).<span class="apidocCodeKeywordSpan">start</span>({ workers: &#x22;./worker.js&#x22;, accessKey
: &#x22;lksjdf982734&#x22; });

	// worker.js
	console.log(&#x22;Hello World&#x22;); // notice we moved our original app logic to the worker



## Talk to it
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.msgBus" id="apidoc.module.cluster-service.msgBus">module cluster-service.msgBus</a></h1>


    <h2>
        <a href="#apidoc.element.cluster-service.msgBus.createMessage" id="apidoc.element.cluster-service.msgBus.createMessage">
        function <span class="apidocSignatureSpan">cluster-service.msgBus.</span>createMessage
        <span class="apidocSignatureSpan">(cmd, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function createMessage(cmd, options) {
  var msg = {
    cservice: util._extend({}, options || {})
  };
  msg.cservice.cmd = cmd;
  return msg;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    if (!cservice.msgBus.isValidMessage(msg)) {
      return; // ignore
    }

    switch (msg.cservice.cmd) {
      case &#x22;netStats&#x22;:
        cservice.processSafeSend(process,
          cservice.msgBus.<span class="apidocCodeKeywordSpan">createMessage</span>(&#x22;netStats&#x22;, {
            netStats: net
        }));
        break;
    }
  });
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.msgBus.isValidMessage" id="apidoc.element.cluster-service.msgBus.isValidMessage">
        function <span class="apidocSignatureSpan">cluster-service.msgBus.</span>isValidMessage
        <span class="apidocSignatureSpan">(msg)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function isValidMessage(msg) {
  if (!msg || !msg.cservice || !msg.cservice.cmd) {
    return false; // ignore invalid cluster-service messages
  }

  return true;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
// TODO: Move worker stats to its own class so this technique can be leveraged
//       for any type of stats in the future.
function monitor() {
  statTimer = setInterval(statTracker, STAT_FREQUENCY);
  statTimer.unref();

  process.on(&#x22;message&#x22;, function(msg) {
if (!cservice.msgBus.<span class="apidocCodeKeywordSpan">isValidMessage</span>(msg)) {
  return; // ignore
}

switch (msg.cservice.cmd) {
  case &#x22;netStats&#x22;:
    cservice.processSafeSend(process,
      cservice.msgBus.createMessage(&#x22;netStats&#x22;, {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.msgBus.processMessage" id="apidoc.element.cluster-service.msgBus.processMessage">
        function <span class="apidocSignatureSpan">cluster-service.msgBus.</span>processMessage
        <span class="apidocSignatureSpan">(msg)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function processMessage(msg) {
  var waiter = waiters[msg.waiterId];
  if (!waiter) {
    return false;
  }

  waiter.cb(msg.error, msg.response);

  return true;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    onStop: (typeof options.onWorkerStop === &#x22;function&#x22;)
  })
);
}

function onMessageFromMaster(msg) {
if (!messageBus.isValidMessage(msg) ||
  cservice.msgBus.<span class="apidocCodeKeywordSpan">processMessage</span>(msg)) {
  return;
}

switch (msg.cservice.cmd) {
  case &#x22;onWorkerStop&#x22;:
    cservice.netServers.close(function() {
      if (typeof onWorkerStop === &#x22;function&#x22;) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.msgBus.respondToMessage" id="apidoc.element.cluster-service.msgBus.respondToMessage">
        function <span class="apidocSignatureSpan">cluster-service.msgBus.</span>respondToMessage
        <span class="apidocSignatureSpan">(msg, process, error, response)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function respondToMessage(msg, process, error, response) {
  msg.error = error;
  msg.response = response;
  cservice.processSafeSend(process, msg);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  break;
case &#x22;trigger&#x22;:
  args = msg.cservice.args;
  if (args &#x26;&#x26; args.length &#x3e; 0) {
    if (msg.cservice.cb === true) {
      args.splice(1, 0, function(err, result) {
        // forward response to worker that requested the trigger
        cservice.msgBus.<span class="apidocCodeKeywordSpan">respondToMessage</span>(msg, worker.process, err, result);
      });
    } else {
      args.splice(1, 0, null); // no callback necessary
    }
    cservice.trigger.apply(cservice, args);
  }
  break;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.msgBus.sendMessage" id="apidoc.element.cluster-service.msgBus.sendMessage">
        function <span class="apidocSignatureSpan">cluster-service.msgBus.</span>sendMessage
        <span class="apidocSignatureSpan">(cmd, options, filter, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function sendMessage(cmd, options, filter, cb) {
  var msg = createMessage(cmd, options);

  if (cluster.isWorker === true) {
    createWaiter(msg, process, cb);
    // send to master and wait for response
    return cservice.processSafeSend(process, msg);
  }

  var workers = cluster.workers;
  if (typeof filter === &#x22;function&#x22;) {
    // filter as directed
    workers = workers.filter(filter);
  }

  var tasks = [];

  workers.forEach(function(worker) {
    tasks.push(createWaiterTask(msg, worker.process, cb));
  });

  // process worker messages, but callback only once
  async.parallel(tasks, function (err, data) {
    if (typeof cb === &#x22;function&#x22;) {
      cb(err, data);
    }
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

module.exports = exports = trigger;

function trigger(eventName, cb) {
var args = Array.prototype.slice.call(arguments);
if (cservice.isWorker === true) {
  args.splice(1, 1); // remove cb from args if it exists
  cservice.msgBus.<span class="apidocCodeKeywordSpan">sendMessage</span>(&#x22;trigger&#x22;, { args: args, cb: true },
    null, function(err, result) {
    // wait for response from master
    if (typeof cb === &#x22;function&#x22;) {
      cb(err, result);
    }
  });
  return;
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.netServers" id="apidoc.module.cluster-service.netServers">module cluster-service.netServers</a></h1>


    <h2>
        <a href="#apidoc.element.cluster-service.netServers.add" id="apidoc.element.cluster-service.netServers.add">
        function <span class="apidocSignatureSpan">cluster-service.netServers.</span>add
        <span class="apidocSignatureSpan">(servers)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function netServersAdd(servers) {
  if (util.isArray(servers) === false) {
    servers = [servers];
  }

  for (var i = 0; i &#x3c; servers.length; i++) {
    var server = servers[i];
    if (server.cservice)
      continue; // ignore if already added

    server.cservice = {
      id: Math.random().toString(), // track by id
      isReady: true // assume true unless known to be otherwise
    };
    cservice.locals.net.servers[server.cservice.id] = server;

    listenToNetServer(server);
    netStats(server);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
}

cservice.locals.workerReady = true;

options = options || {};

if (options.servers) {
  require(&#x22;./net-servers&#x22;).<span class="apidocCodeKeywordSpan">add</span>(options.servers);
}

onWorkerStop = options.onWorkerStop;

process.on(&#x22;message&#x22;, onMessageFromMaster);

// allow worker to inform the master when ready to speed up initialization
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.netServers.close" id="apidoc.element.cluster-service.netServers.close">
        function <span class="apidocSignatureSpan">cluster-service.netServers.</span>close
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function netServersClose(cb) {
  var tasks = [];

  for (var id in cservice.locals.net.servers) {
    var server = cservice.locals.net.servers[id];
    if (!server.cservice || server.cservice.isReady === false)
      continue;

    tasks.push(createWaitForCloseTask(server));
  }

  if (tasks.length === 0) {
    return cb();
  }

  async.parallel(tasks, cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

server.on(&#x22;error&#x22;, cb);
server.listen(options.port, options.host, cb);
};

exports.close = function() {
try {
  server.<span class="apidocCodeKeywordSpan">close</span>();
} catch (ex) {
}
};

function processRequest(req, res) {
var qsIdx, qs, question;
try {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.netServers.remove" id="apidoc.element.cluster-service.netServers.remove">
        function <span class="apidocSignatureSpan">cluster-service.netServers.</span>remove
        <span class="apidocSignatureSpan">(servers)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function netServersRemove(servers) {
  if (util.isArray(servers) === false) {
    servers = [servers];
  }

  for (var i = 0; i &#x3c; servers.length; i++) {
    var server = servers[i];
    if (!server.cservice)
      continue; // ignore if not tracked by cservice
    // stop tracking
    delete cservice.locals.net.servers[server.cservice.id];
    // unreference from cservice
    delete server.cservice;

    stopListeningToNetServer(server);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.netServers.waitForReady" id="apidoc.element.cluster-service.netServers.waitForReady">
        function <span class="apidocSignatureSpan">cluster-service.netServers.</span>waitForReady
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function netServersWaitForReady(cb) {
  var tasks = [];

  for (var id in cservice.locals.net.servers) {
    var server = cservice.locals.net.servers[id];
    if (!server.cservice || server.cservice.isReady === true)
      continue;

    tasks.push(createWaitForReadyTask(server));
  }

  if (tasks.length === 0) {
    return cb();
  }

  async.parallel(tasks, cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
// it&#x27;s avail
setImmediate(function() {
  cluster.worker.module = require(process.env.worker);
  if (global.cservice.locals.workerReady === undefined
    &#x26;&#x26; process.env.ready.toString() === &#x22;false&#x22;) {
    // if workerReady not invoked explicitly, we&#x27;ll track it automatically
    exports.workerReady(false);
    exports.netServers.<span class="apidocCodeKeywordSpan">waitForReady</span>(function() {
      exports.workerReady(); // NOW we&#x27;re ready
    });
  }
});

// start worker monitor to establish two-way relationship with master
workers.monitor();
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.options" id="apidoc.module.cluster-service.options">module cluster-service.options</a></h1>




    <h2>
        <a href="#apidoc.element.cluster-service.options.options" id="apidoc.element.cluster-service.options.options">
        function <span class="apidocSignatureSpan">cluster-service.</span>options
        <span class="apidocSignatureSpan">(evt, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">options = function (evt, cb) {
  cb(null, cservice.locals);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.options.control" id="apidoc.element.cluster-service.options.control">
        function <span class="apidocSignatureSpan">cluster-service.options.</span>control
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">control = function () {
  return &#x22;local&#x22;;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
};
```

Or may be overriden at runtime via:

```javascript
// server.js
require(&#x22;cluster-service&#x22;).<span class="apidocCodeKeywordSpan">control</span>({ &#x22;exit&#x22;: &#x22;local&#x22; });
```

## Proxy Support

Proxy mode specifically caters to Web Servers that you want to enable automatic
versioning of your service. Any version requested (via `versionHeader`) that is
not yet loaded will automatically have a worker process spun up with the new
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.options.more" id="apidoc.element.cluster-service.options.more">
        function <span class="apidocSignatureSpan">cluster-service.options.</span>more
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">more = function (cb) {
  cb(null, {
    command: &#x22;options&#x22;,
    info: &#x22;Returns current options for debug purposes.&#x22;
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  if (typeof cmdName === &#x22;string&#x22;) {
ret.command = cmdName;
cmd = evt.locals.events[cmdName];
if (!cmd) {
  ret.err = &#x22;Command not found&#x22;;
} else {
  if (typeof cmd.cb.more === &#x22;function&#x22;) {
    cmd.cb.<span class="apidocCodeKeywordSpan">more</span>(function(err, result) {
      cb(null, result);
    });
    return;
  } else {
    ret.more = &#x22;No additional details found.&#x22;;
  }
}
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.proxy" id="apidoc.module.cluster-service.proxy">module cluster-service.proxy</a></h1>


    <h2>
        <a href="#apidoc.element.cluster-service.proxy.getProxyWorkers" id="apidoc.element.cluster-service.proxy.getProxyWorkers">
        function <span class="apidocSignatureSpan">cluster-service.proxy.</span>getProxyWorkers
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function getProxyWorkers() {
  return cservice.workers.filter(function(worker) {
    return worker.cservice.type === &#x22;proxy&#x22;;
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.proxy.getVersionWorkers" id="apidoc.element.cluster-service.proxy.getVersionWorkers">
        function <span class="apidocSignatureSpan">cluster-service.proxy.</span>getVersionWorkers
        <span class="apidocSignatureSpan">(explicitVersion)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function getVersionWorkers(explicitVersion) {
  return cservice.workers.filter(function(worker) {
    var result =
      typeof worker.cservice.version === &#x22;string&#x22; &#x26;&#x26;
      (!explicitVersion || worker.cservice.version === explicitVersion)
    ;
    return result;
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
        });
        cluster.on(&#x22;exit&#x22;, function(worker, code, signal) {
          // stop tracking
          var version = cservice.locals.proxy.versions[worker.cservice.version];
          if (version) {
// get all proxy workers for a specific version
var versionWorkers =
  cservice.proxy.<span class="apidocCodeKeywordSpan">getVersionWorkers</span>(worker.cservice.version);
// exclude our exiting worker process in case it&#x27;s still returned
versionWorkers = versionWorkers.filter(function(versionWorker) {
  return worker.process.pid !== versionWorker.process.pid;
});

if (versionWorkers.length === 0) {
  // if no workers remain for a given version, drop the version
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.proxy.info" id="apidoc.element.cluster-service.proxy.info">
        function <span class="apidocSignatureSpan">cluster-service.proxy.</span>info
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function info(cb) {
  if (cluster.isWorker === true) {
    cservice.log(&#x22;Proxy cannot invoke &#x27;info&#x27; from worker&#x22;.warn);
    return cb &#x26;&#x26; cb(&#x22;Proxy cannot invoke &#x27;info&#x27; from worker&#x22;);
  }

  var now = Date.now();
  var proxyWorkers = getProxyWorkers().map(function(worker) {
    var bindingInfo = JSON.parse(worker.cservice.bindingInfo);
    return {
      port: bindingInfo.port,
      ssl: typeof bindingInfo.tlsOptions === &#x22;object&#x22;
    };
  });
  var versionWorkers = getVersionWorkers().map(function(worker) {
    var versionInfo = cservice.locals.proxy.versions[worker.cservice.version];
    return {
      worker: worker.cservice.worker,
      version: worker.cservice.version,
      lastAccess: versionInfo ?
        Math.round((now - versionInfo.lastAccess) / 1000) : &#x22;?&#x22;
    };
  });

  cb(null, {
    versionPath: cservice.locals.proxy.versionPath,
    workerFilename: cservice.locals.proxy.workerFilename,
    portRange: cservice.locals.proxy.portRange,
    options: cservice.locals.proxy.options,
    proxyWorkers: proxyWorkers,
    versionWorkers: versionWorkers
  });

}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
      options = {};
      if (arguments[4]) {
        options.workerCount = parseInt(arguments[4]);
      }
      cservice.proxy.promote(versionStr, options, cb);
      break;
    case &#x22;info&#x22;:
      cservice.proxy.<span class="apidocCodeKeywordSpan">info</span>(cb);
      break;
    default:
      cb(&#x22;Proxy command &#x22; + cmd +
        &#x22; not recognized. Try &#x27;help proxy&#x27; for more info.&#x22;);
      break;
  }
};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.proxy.promote" id="apidoc.element.cluster-service.proxy.promote">
        function <span class="apidocSignatureSpan">cluster-service.proxy.</span>promote
        <span class="apidocSignatureSpan">(versionStr, options, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function promote(versionStr, options, cb) {
  if (cluster.isWorker === true) {
    cservice.log(&#x22;Proxy cannot invoke &#x27;promote&#x27; from worker&#x22;.warn);
    return cb &#x26;&#x26; cb(&#x22;Proxy cannot invoke &#x27;promote&#x27; from worker&#x22;);
  }

  options = options || {};
  options.workerCount = options.workerCount ||
    cservice.locals.options.workerCount
  ;

  var oldVersion = cservice.locals.proxy.versions[
    cservice.locals.proxy.options.defaultVersion
  ];

  // set to-be-promoted version to desired worker count
  version(versionStr, options, function (err) {
    if (err) {
      // pass failure on
      return cb &#x26;&#x26; cb(err);
    }

    // persist to-be-promoted version
    cservice.locals.proxy.options.defaultVersion = versionStr;
    fs.writeFile(cservice.locals.proxy.configPath,
      JSON.stringify(cservice.locals.proxy.options, null, &#x22;  &#x22;), function(err) {
      if (err) {
        // pass failure on
        cservice.error(&#x22;Failed to proxy promote version&#x22;.error +
          versionStr.info
        );
        return cb &#x26;&#x26; cb(err);
      }

      // notify proxy-workers of promoted version
      updateProxyWorkers();

      cservice.log(&#x22;Proxy promoted version &#x22;.success +
        versionStr.info +
        &#x22; successfully&#x22;.success
      );

      // bring previously promoted version down to
      // `nonDefaultWorkerCount` workers, but no need to wait for callback
      if (oldVersion &#x26;&#x26; oldVersion.name !== versionStr) {
        version(oldVersion.name,
          {
            workerCount: cservice.locals.proxy.options.nonDefaultWorkerCount,
            reason: &#x22;proxy demote&#x22;
          }, function(err) {
            if (err) {
              return cservice.error(&#x22;Failed to proxy demote version&#x22;.error +
                oldVersion.name.info
              );
            }

            cservice.log(&#x22;Proxy demoted old version &#x22;.success +
              oldVersion.name.info +
              &#x22; successfully&#x22;.success
            );
          }
        );
      }

      if (cb) {
        setImmediate(cb);
      }
    });
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  break;
case &#x22;promote&#x22;:
  versionStr = arguments[3];
  options = {};
  if (arguments[4]) {
    options.workerCount = parseInt(arguments[4]);
  }
  cservice.proxy.<span class="apidocCodeKeywordSpan">promote</span>(versionStr, options, cb);
  break;
case &#x22;info&#x22;:
  cservice.proxy.info(cb);
  break;
default:
  cb(&#x22;Proxy command &#x22; + cmd +
    &#x22; not recognized. Try &#x27;help proxy&#x27; for more info.&#x22;);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.proxy.start" id="apidoc.element.cluster-service.proxy.start">
        function <span class="apidocSignatureSpan">cluster-service.proxy.</span>start
        <span class="apidocSignatureSpan">(options, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function start(options, cb) {
  if (cluster.isWorker === true) {
    cservice.log(&#x22;Proxy cannot be started from worker&#x22;.warn);
    return cb &#x26;&#x26; cb(&#x22;Proxy cannot be started from worker&#x22;);
  }

  var configPath = options.configPath || cservice.options.proxy;

  if (typeof configPath !== &#x22;string&#x22;) {
    // disabled
    return cb &#x26;&#x26; cb();
  }

  if (cservice.locals.proxy.enabled === true) {
    cservice.log(&#x22;Proxy already running&#x22;.warn);
    return cb &#x26;&#x26; cb(&#x22;Proxy already running&#x22;);
  }

  cservice.locals.proxy.configPath = path.resolve(configPath);
  cservice.locals.proxy.options =
    JSON.parse(fs.readFileSync(cservice.locals.proxy.configPath))
  ;

  options = cservice.locals.proxy.options;

  if (Array.isArray(options.bindings) === false ||
    options.bindings.length === 0) {
    options.bindings = [{ port: 80, workerCount: 2 }]; // default
  }

  options.nonDefaultWorkerCount = options.nonDefaultWorkerCount || 1;
  options.nonDefaultWorkerIdleTime = options.nonDefaultWorkerIdleTime || 3600;

  cservice.locals.proxy.versionPath =
    options.versionPath || path.dirname(cservice.locals.proxy.configPath)
  ;
  cservice.locals.proxy.versionPath =
    path.resolve(cservice.locals.proxy.versionPath)
  ;
  cservice.locals.proxy.workerFilename = options.workerFilename || &#x22;worker.js&#x22;;
  cservice.locals.proxy.versionHeader = options.versionHeader || &#x22;x-version&#x22;;

  var portRange = (options.versionPorts || &#x22;11000-12000&#x22;).split(&#x22;-&#x22;);
  cservice.locals.proxy.portRange = {
    min: parseInt(portRange[0]),
    max: parseInt(portRange[1])
  };
  cservice.locals.proxy.nextAvailablePortIndex = 0;

  var proxyWorkerTasks = options.bindings.map(function(b) {
    return function(cb) {
      var workerOptions = {
        type: &#x22;proxy&#x22;, // proxy worker type
        worker: path.resolve(__dirname, &#x22;proxy-worker.js&#x22;),
        bindingInfo: JSON.stringify(b),
        versionPath: cservice.locals.proxy.versionPath,
        versionHeader: cservice.locals.proxy.versionHeader,
        workerFilename: cservice.locals.proxy.workerFilename,
        versions: JSON.stringify(cservice.locals.proxy.versions),
        count: b.workerCount || 2
      };
      cservice.newWorker(workerOptions, cb);
    };
  });

  cservice.locals.proxy.refreshnessTimer =
    setInterval(checkVersionsForFreshness, 10000)
  ;
  cservice.locals.proxy.refreshnessTimer.unref();

  cservice.locals.proxy.enabled = true;

  async.parallel(proxyWorkerTasks, function (err) {
    var portArr = options.bindings.map(function(b) {
      return b.port.toString().data;
    });

    if (err) {
      cservice.error(&#x22;Proxy failed to run on ports &#x22;.error +
        portArr.join(&#x22;,&#x22;.info) + &#x22; with error &#x22;.error + err.toString().data);
      return cb &#x26;&#x26; cb(err);
    }

    cservice.log(&#x22;Proxy running on ports &#x22;.info + portArr.join(&#x22;,&#x22;.info));

    if (!cservice.locals.proxy.options.defaultVersion) {
      // no current version

      return cb &#x26;&#x26; cb();
    }

    version(cservice.locals.proxy.options.defaultVersion,
      { workerCount: cservice.locals.options.workerCount },
      function (err, version) {
      if (err) {
        cservice.error(&#x22;Proxy failed to run on ports &#x22;.error +
          portArr.join(&#x22;,&#x22;.info) + &#x22; with error &#x22;.error + err.toString().data
        );
        return cb &#x26;&#x26; cb(err);
      }

      return cb &#x26;&#x26; cb();
    });
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
Now we can leverage ```npm``` to find our local install of ```cluster-service```:

	npm start

Or, if you prefer to control ```cluster-service``` within your code, we&#x27;ve got you covered:

	// server.js
	require(&#x22;cluster-service&#x22;).<span class="apidocCodeKeywordSpan">start</span>({ workers: &#x22;./worker.js&#x22;, accessKey
: &#x22;lksjdf982734&#x22; });

	// worker.js
	console.log(&#x22;Hello World&#x22;); // notice we moved our original app logic to the worker



## Talk to it
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.proxy.stop" id="apidoc.element.cluster-service.proxy.stop">
        function <span class="apidocSignatureSpan">cluster-service.proxy.</span>stop
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function stop(cb) {
  if (cluster.isWorker === true) {
    cservice.log(&#x22;Proxy cannot be stopped from worker&#x22;.warn);
    return cb &#x26;&#x26; cb(&#x22;Proxy cannot be stopped from worker&#x22;);
  }

  if (typeof cservice.locals.proxy.configPath !== &#x22;string&#x22;) {
    // disabled
    return cb &#x26;&#x26; cb();
  }

  if (cservice.locals.proxy.enabled === false) {
    cservice.log(&#x22;Proxy not running&#x22;.warn);
    return cb &#x26;&#x26; cb(&#x22;Proxy not running&#x22;);
  }

  clearInterval(cservice.locals.proxy.refreshnessTimer);
  cservice.locals.proxy.refreshnessTimer = null;

  // now lets trigger a shutdown
  cservice.trigger(&#x22;shutdown&#x22;, function(err, result) {
    cservice.locals.proxy.enabled = false;
    return cb &#x26;&#x26; cb();
  }, &#x22;all&#x22;);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
module.exports = function(evt, cb, cmd) {
var versionStr, options;
switch (cmd) {
  case &#x22;start&#x22;:
    cservice.proxy.start({ configPath: arguments[3] }, cb);
    break;
  case &#x22;stop&#x22;:
    cservice.proxy.<span class="apidocCodeKeywordSpan">stop</span>(cb);
    break;
  case &#x22;version&#x22;:
    versionStr = arguments[3];
    options = {};
    if (arguments[4]) {
      options.workerCount = parseInt(arguments[4]);
    }
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.proxy.updateProxyWorkers" id="apidoc.element.cluster-service.proxy.updateProxyWorkers">
        function <span class="apidocSignatureSpan">cluster-service.proxy.</span>updateProxyWorkers
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function updateProxyWorkers() {
  var msg = cservice.msgBus.createMessage(&#x22;proxyVersions&#x22;, {
    versions: cservice.locals.proxy.versions,
    defaultVersion: cservice.locals.proxy.options.defaultVersion
  });
  getProxyWorkers().forEach(function(worker) {
    worker.send(msg);
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  });

  if (versionWorkers.length === 0) {
    // if no workers remain for a given version, drop the version
    delete cservice.locals.proxy.versions[worker.cservice.version];

    // inform proxy workers of version change
    cservice.proxy.<span class="apidocCodeKeywordSpan">updateProxyWorkers</span>();
  }
}
delete cservice.locals.workerProcesses[worker.process.pid];

cservice.trigger(&#x22;workerExit&#x22;, worker);
// do not restart if there is a reason, or disabled
if (
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.proxy.version" id="apidoc.element.cluster-service.proxy.version">
        function <span class="apidocSignatureSpan">cluster-service.proxy.</span>version
        <span class="apidocSignatureSpan">(versionStr, options, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function version(versionStr, options, cb) {
  if (cluster.isWorker === true) {
    cservice.log(&#x22;Proxy cannot invoke &#x27;version&#x27; from worker&#x22;.warn);
    return cb &#x26;&#x26; cb(&#x22;Proxy cannot invoke &#x27;version&#x27; from worker&#x22;);
  }

  options = options || {};
  if (isNaN(options.workerCount) === true) {
    options.workerCount =
      (versionStr === cservice.locals.proxy.options.defaultVersion)
      ? cservice.locals.options.workerCount
      : cservice.locals.proxy.options.nonDefaultWorkerCount
    ;
  }

  // detect current version worker count
  var currentVersionWorkers = getVersionWorkers(versionStr);

  // determine worker delta from desired count and actual count
  var workerCountDelta = options.workerCount - currentVersionWorkers.length;

  // get existing version listing
  var v = cservice.locals.proxy.versions[versionStr];

  if (v) {
    // update version lastAccess
    v.lastAccess = Date.now();
  }

  // if version worker count is already current, nothing more to do
  if (workerCountDelta === 0) {
    return cb &#x26;&#x26; cb();
  }

  if (workerCountDelta &#x3c; 0) {
    // if desired version count is less than current, reduce worker count
    var workersToShutdown = currentVersionWorkers.length - options.workerCount;
    var shutdownTasks = [];
    for (var workerToShutdown = 0; workerToShutdown &#x3c; workersToShutdown;
      workerToShutdown++) {
      shutdownTasks.push(
        getWorkerShutdownTask(
          currentVersionWorkers[workerToShutdown],
          options.reason || &#x22;proxy version&#x22;
        )
      );
    }

    // shutdown all at once
    async.parallel(shutdownTasks, function (err, results) {
      return cb &#x26;&#x26; cb(err);
    });

    return;
  }

  // if desired version count is more than current, spin up new workers

  var workerPath = path.resolve(cservice.locals.proxy.versionPath,
    versionStr, cservice.locals.proxy.workerFilename
  );

  // use existing port if available, otherwise allocate a new one
  var versionPort = (v &#x26;&#x26; v.port) || getNextAvailablePort();

  cservice.trigger(&#x22;start&#x22;, function (err, result) {
    return cb &#x26;&#x26; cb(err, result);
  }, workerPath, {
    count: workerCountDelta,
    version: versionStr,
    PROXY_PORT: versionPort
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  break;
case &#x22;version&#x22;:
  versionStr = arguments[3];
  options = {};
  if (arguments[4]) {
    options.workerCount = parseInt(arguments[4]);
  }
  cservice.proxy.<span class="apidocCodeKeywordSpan">version</span>(versionStr, options, cb);
  break;
case &#x22;promote&#x22;:
  versionStr = arguments[3];
  options = {};
  if (arguments[4]) {
    options.workerCount = parseInt(arguments[4]);
  }
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.restart" id="apidoc.module.cluster-service.restart">module cluster-service.restart</a></h1>


    <h2>
        <a href="#apidoc.element.cluster-service.restart.restart" id="apidoc.element.cluster-service.restart.restart">
        function <span class="apidocSignatureSpan">cluster-service.</span>restart
        <span class="apidocSignatureSpan">(evt, cb, cmd, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">restart = function (evt, cb, cmd, options) {
  var pid = parseInt(cmd),
      originalAutoRestart,
      tasks;
  options = options || {};
  options.timeout = parseInt(options.timeout) || 60000;
  if (cmd !== &#x22;all&#x22; &#x26;&#x26; !pid) {
    cb(&#x22;Invalid request. Try help restart&#x22;);
    return;
  }

  evt.locals.reason = &#x22;restart&#x22;;
  originalAutoRestart = evt.locals.restartOnFailure;
  evt.locals.restartOnFailure = false;

  tasks = [];

  evt.service.workers.forEach(function(worker){
    if (pid &#x26;&#x26; worker.process.pid !== pid) {
      return; // cannot kill external processes
    }

    tasks.push(getTask(evt, worker, options, (pid ? true : false)));
  });

  if (tasks.length === 0) {
    cb(&#x22;No workers to restart&#x22;);
  } else {
    cservice.log(
      &#x22;Restarting workers... timeout: &#x22;.warn + options.timeout.toString().info
    );

    var limit = 1 +
        Math.floor(
            tasks.length * cservice.options.restartConcurrencyRatio
        );
    async.parallelLimit(tasks, limit, function(err) {
      evt.locals.restartOnFailure = originalAutoRestart; // restore

      if (err) {
        cb(err);
      } else {
        cb(null, tasks.length + &#x22; workers restarted successfully&#x22;);
      }
    });
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.restart.more" id="apidoc.element.cluster-service.restart.more">
        function <span class="apidocSignatureSpan">cluster-service.restart.</span>more
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">more = function (cb) {
  cb(null, {
    info: [
      &#x22;Gracefully restart service, waiting up to timeout before terminating&#x22;,
      &#x22;workers.&#x22;
    ].join(&#x27; &#x27;),
    command: &#x22;restart all|pid { \&#x22;option1\&#x22;: \&#x22;value\&#x22; }&#x22;,
    &#x22;all|pid&#x22;: [
      &#x22;Required. &#x27;all&#x27; to force shutdown of all workers, otherwise the pid of&#x22;,
      &#x22;the specific worker to restart&#x22;
    ].join(&#x27; &#x27;),
    &#x22;options&#x22;: &#x22;An object of options.&#x22;,
    &#x22;* timeout&#x22;: [
      &#x22;Timeout, in milliseconds, before terminating workers.&#x22;,
      &#x22;0 for infinite wait.&#x22;
    ].join(&#x27; &#x27;)
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  if (typeof cmdName === &#x22;string&#x22;) {
ret.command = cmdName;
cmd = evt.locals.events[cmdName];
if (!cmd) {
  ret.err = &#x22;Command not found&#x22;;
} else {
  if (typeof cmd.cb.more === &#x22;function&#x22;) {
    cmd.cb.<span class="apidocCodeKeywordSpan">more</span>(function(err, result) {
      cb(null, result);
    });
    return;
  } else {
    ret.more = &#x22;No additional details found.&#x22;;
  }
}
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.run" id="apidoc.module.cluster-service.run">module cluster-service.run</a></h1>


    <h2>
        <a href="#apidoc.element.cluster-service.run.start" id="apidoc.element.cluster-service.run.start">
        function <span class="apidocSignatureSpan">cluster-service.run.</span>start
        <span class="apidocSignatureSpan">(o, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">start = function (o, cb) {
  var cmd;
  options = o;

  cmd = options.run;
  delete options.run;

  run(cmd, cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
Now we can leverage ```npm``` to find our local install of ```cluster-service```:

	npm start

Or, if you prefer to control ```cluster-service``` within your code, we&#x27;ve got you covered:

	// server.js
	require(&#x22;cluster-service&#x22;).<span class="apidocCodeKeywordSpan">start</span>({ workers: &#x22;./worker.js&#x22;, accessKey
: &#x22;lksjdf982734&#x22; });

	// worker.js
	console.log(&#x22;Hello World&#x22;); // notice we moved our original app logic to the worker



## Talk to it
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.shutdown" id="apidoc.module.cluster-service.shutdown">module cluster-service.shutdown</a></h1>


    <h2>
        <a href="#apidoc.element.cluster-service.shutdown.shutdown" id="apidoc.element.cluster-service.shutdown.shutdown">
        function <span class="apidocSignatureSpan">cluster-service.</span>shutdown
        <span class="apidocSignatureSpan">(evt, cb, cmd, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">shutdown = function (evt, cb, cmd, options) {
  var pid = parseInt(cmd);
  var workersToKill;
  var exiting;

  options = options || {};
  options.timeout = parseInt(options.timeout) || 60000;
  if (cmd !== &#x22;all&#x22; &#x26;&#x26; !pid) {
    cb(&#x22;Invalid request. Try help shutdown&#x22;);
    return;
  }

  evt.locals.reason = &#x22;shutdown&#x22;;

  workersToKill = 0;

  exiting = false;
  evt.service.workers.forEach(function(worker){
    if (pid &#x26;&#x26; worker.process.pid !== pid) {
      return; // cannot kill external processes
    }

    exiting = true;
    workersToKill++;

    var killTimeout = options.timeout &#x3e; 0
      ? setTimeout(getKiller(worker), options.timeout)
      : null;
    worker.on(&#x22;exit&#x22;, getExitHandler(evt, worker, killTimeout, function() {
      workersToKill--;
      if (workersToKill === 0) {
        // no workers remain
        if (evt.service.workers.length === 0) {
          evt.locals.reason = &#x22;kill&#x22;;
          cservice.log(&#x22;All workers shutdown. Exiting...&#x22;.warn);
          evt.service.stop(options.timeout, cb);
        } else {
          cb(null, &#x22;Worker shutdown&#x22;); // DONE
        }
      }
    }));

    require(&#x22;../workers&#x22;).exitGracefully(worker);
  });

  if (exiting === false) {
    if (evt.service.workers.length === 0) {
      evt.locals.reason = &#x22;kill&#x22;;
      cservice.log(&#x22;All workers shutdown. Exiting...&#x22;);
      evt.service.stop(options.timeout, cb);
    } else {
      cb(&#x22;No workers were shutdown&#x22;);
    }
  } else {
    cservice.log(
      &#x22;Killing workers... timeout: &#x22;.warn +
      (options.timeout || 0).toString().info
    );
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.shutdown.control" id="apidoc.element.cluster-service.shutdown.control">
        function <span class="apidocSignatureSpan">cluster-service.shutdown.</span>control
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">control = function () {
  return &#x22;local&#x22;;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
};
```

Or may be overriden at runtime via:

```javascript
// server.js
require(&#x22;cluster-service&#x22;).<span class="apidocCodeKeywordSpan">control</span>({ &#x22;exit&#x22;: &#x22;local&#x22; });
```

## Proxy Support

Proxy mode specifically caters to Web Servers that you want to enable automatic
versioning of your service. Any version requested (via `versionHeader`) that is
not yet loaded will automatically have a worker process spun up with the new
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.shutdown.more" id="apidoc.element.cluster-service.shutdown.more">
        function <span class="apidocSignatureSpan">cluster-service.shutdown.</span>more
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">more = function (cb) {
  cb(null, {
    info: [
      &#x22;Gracefully shutdown service, waiting up to timeout before terminating&#x22;,
      &#x22;workers.&#x22;
    ].join(&#x27; &#x27;),
    command: &#x22;shutdown all|pid { \&#x22;option1\&#x22;: \&#x22;value\&#x22; }&#x22;,
    &#x22;all|pid&#x22;: [
      &#x22;Required. &#x27;all&#x27; to force shutdown of all workers, otherwise the pid of&#x22;,
      &#x22;the specific worker to shutdown&#x22;
    ].join(&#x27; &#x27;),
    &#x22;options&#x22;: &#x22;An object of options.&#x22;,
    &#x22;* timeout&#x22;: [
      &#x22;Timeout, in milliseconds, before terminating workers. 0 for infinite&#x22;,
      &#x22;wait.&#x22;
    ].join(&#x27; &#x27;)
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  if (typeof cmdName === &#x22;string&#x22;) {
ret.command = cmdName;
cmd = evt.locals.events[cmdName];
if (!cmd) {
  ret.err = &#x22;Command not found&#x22;;
} else {
  if (typeof cmd.cb.more === &#x22;function&#x22;) {
    cmd.cb.<span class="apidocCodeKeywordSpan">more</span>(function(err, result) {
      cb(null, result);
    });
    return;
  } else {
    ret.more = &#x22;No additional details found.&#x22;;
  }
}
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.start" id="apidoc.module.cluster-service.start">module cluster-service.start</a></h1>


    <h2>
        <a href="#apidoc.element.cluster-service.start.start" id="apidoc.element.cluster-service.start.start">
        function <span class="apidocSignatureSpan">cluster-service.</span>start
        <span class="apidocSignatureSpan">(options, masterCb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function start(options, masterCb) {
  var argv;
  if (cluster.isWorker === true) {
    // ignore starts if not master. do NOT invoke masterCb, as that is
    // reserved for master callback

    return;
  }

  if (arguments.length === 0) {
    argv = require(&#x22;optimist&#x22;).argv;

    options = argv; // use command-line arguments instead
    if (!(&#x22;cli&#x22; in options)) {
      options.cli = true; // auto-enable cli if run from command-line
    }
    prepArgs(options);
    masterCb = masterCallback;
  }

  options = options || {};
  if (&#x22;config&#x22; in options) {
    // only extend with config, do not overwrite command-line options
    var fileOptions = JSON.parse(fs.readFileSync(options.config));
    options = util._extend(fileOptions, options);
  }
  cservice.locals.options = util._extend(cservice.locals.options, options);
  if (&#x22;workers&#x22; in options) { // overwrite workers if provided
    cservice.locals.options.workers = options.workers;
  }
  options = cservice.locals.options;
  if (typeof options.workers === &#x22;string&#x22;) {
    options.workers = {
      main: {
        worker: options.workers
      }
    };
  }
  if (options.commands) {
    cservice.registerCommands(options.commands);
  }

  colors.setTheme(options.colors);

  require(&#x22;./legacy&#x22;);

  if (options.run) {
    require(&#x22;./run&#x22;).start(options, function(err, result) {
      if (masterCb &#x26;&#x26; masterCb(err, result) === false) {
        return; // do not exit if cb returns false
      }
      process.exit(0); // graceful exit
    });
  } else {
    require(&#x22;./master&#x22;).start(options, masterCb);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
Now we can leverage ```npm``` to find our local install of ```cluster-service```:

	npm start

Or, if you prefer to control ```cluster-service``` within your code, we&#x27;ve got you covered:

	// server.js
	require(&#x22;cluster-service&#x22;).<span class="apidocCodeKeywordSpan">start</span>({ workers: &#x22;./worker.js&#x22;, accessKey
: &#x22;lksjdf982734&#x22; });

	// worker.js
	console.log(&#x22;Hello World&#x22;); // notice we moved our original app logic to the worker



## Talk to it
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.start.prepArgs" id="apidoc.element.cluster-service.start.prepArgs">
        function <span class="apidocSignatureSpan">cluster-service.start.</span>prepArgs
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function prepArgs(options) {
  var ext;
  if (options._ &#x26;&#x26; options._.length &#x3e; 0) {
    ext = path.extname(options._[0]).toLowerCase();
    if (ext === &#x22;.js&#x22;) { // if js file, use as worker
      options.workers = options._[0];
    } else if (ext === &#x22;.json&#x22;) { // if json file, use as config
      options.config = options._[0];
    } else { // otherwise assume it is a command to execute
      options.run = options._[0];
      if (options.json === true) {
        options.cli = false;
      }
    }
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.upgrade" id="apidoc.module.cluster-service.upgrade">module cluster-service.upgrade</a></h1>


    <h2>
        <a href="#apidoc.element.cluster-service.upgrade.upgrade" id="apidoc.element.cluster-service.upgrade.upgrade">
        function <span class="apidocSignatureSpan">cluster-service.</span>upgrade
        <span class="apidocSignatureSpan">(evt, cb, cmd, workerPath, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">upgrade = function (evt, cb, cmd, workerPath, options) {
  var pid = parseInt(cmd);
  var originalAutoRestart;
  var tasks;
  var workerOptions;

  options = options || {};
  options.timeout = parseInt(options.timeout) || 60000;
  options.worker = workerPath;
  if (typeof workerPath !== &#x22;string&#x22; || (cmd !== &#x22;all&#x22; &#x26;&#x26; !pid)) {
    cb(&#x22;Invalid request. Try help upgrade&#x22;);
    return;
  }

  evt.locals.reason = &#x22;upgrade&#x22;;
  originalAutoRestart = evt.locals.restartOnFailure;
  evt.locals.restartOnFailure = false;

  tasks = [];

  evt.service.workers.forEach(function(worker){
    if (pid &#x26;&#x26; worker.process.pid !== pid) {
      return; // cannot kill external processes
    }

    // use original worker options as default, by overwrite using new options
    workerOptions = util._extend(util._extend({}, worker.cservice), options);

    tasks.push(getTask(evt, worker, workerOptions));
  });

  if (tasks.length === 0) {
    cb(&#x22;No workers to upgrade&#x22;);
  } else {
    cservice.log(&#x22;Upgrading workers... timeout: &#x22; + (options.timeout || 0));

    var limit = 1 +
        Math.floor(
            tasks.length * cservice.options.restartConcurrencyRatio
        );
    async.parallelLimit(tasks, limit, function(err) {
      evt.locals.restartOnFailure = originalAutoRestart;

      if (err) {
        cb(err);
      } else {
        cb(null, tasks.length + &#x22; workers upgraded successfully&#x22;);
      }
    });
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.upgrade.more" id="apidoc.element.cluster-service.upgrade.more">
        function <span class="apidocSignatureSpan">cluster-service.upgrade.</span>more
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">more = function (cb) {
  cb(null, {
    info: &#x22;Gracefully upgrade service, one worker at a time.&#x22;,
    command: &#x22;upgrade all|pid workerPath { \&#x22;option1\&#x22;: \&#x22;value\&#x22; }&#x22;,
    &#x22;all|pid&#x22;: [
      &#x22;Required. &#x27;all&#x27; to force shutdown of all workers, otherwise the pid of&#x22;,
      &#x22;the specific worker to upgrade&#x22;
    ].join(&#x27; &#x27;),
    &#x22;workerPath&#x22;:[
      &#x22;Path of worker file (i.e. /workers/worker) to start, absolute path, or&#x22;,
      &#x22;relative to cwd.&#x22;
    ].join(&#x27; &#x27;),
    &#x22;options&#x22;: &#x22;An object of options.&#x22;,
    &#x22;* cwd&#x22;:[
      &#x22;Path to set as the current working directory. If not provided, existing&#x22;,
      &#x22;cwd will be used.&#x22;
    ].join(&#x27; &#x27;),
    &#x22;* timeout&#x22;: [
      &#x22;Timeout, in milliseconds, before terminating replaced workers. 0 for&#x22;,
      &#x22;infinite wait.&#x22;
    ].join(&#x27; &#x27;)
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  if (typeof cmdName === &#x22;string&#x22;) {
ret.command = cmdName;
cmd = evt.locals.events[cmdName];
if (!cmd) {
  ret.err = &#x22;Command not found&#x22;;
} else {
  if (typeof cmd.cb.more === &#x22;function&#x22;) {
    cmd.cb.<span class="apidocCodeKeywordSpan">more</span>(function(err, result) {
      cb(null, result);
    });
    return;
  } else {
    ret.more = &#x22;No additional details found.&#x22;;
  }
}
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.util" id="apidoc.module.cluster-service.util">module cluster-service.util</a></h1>


    <h2>
        <a href="#apidoc.element.cluster-service.util.debug" id="apidoc.element.cluster-service.util.debug">
        function <span class="apidocSignatureSpan">cluster-service.util.</span>debug
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function debug() {
  var args;
  var i;
  if (cservice.options.cli === true &#x26;&#x26; cservice.options.debug) {
    if(process.stdout.clearLine){
      process.stdout.clearLine();
    }
    if(process.stdout.cursorTo){
      process.stdout.cursorTo(0);
    }

    args = Array.prototype.slice.call(arguments);
    for (i = 0; i &#x3c; args.length; i++) {
      if (typeof args[i] === &#x22;string&#x22;) {
        args[i] = args[i].debug;
      }
    }
    if (args.length &#x3e; 0 &#x26;&#x26; typeof args[0] === &#x22;string&#x22; &#x26;&#x26; args[0][0] === &#x22;{&#x22;) {
      cservice.options.debug(&#x22;cservice:&#x22;.cservice);
    } else {
      args = [&#x22;cservice: &#x22;.cservice].concat(args);
    }
    cservice.options.debug.apply(this, args);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    args = Array.prototype.slice.call(arguments);
    for (i = 0; i &#x3c; args.length; i++) {
      if (typeof args[i] === &#x22;string&#x22;) {
        args[i] = args[i].debug;
      }
    }
    if (args.length &#x3e; 0 &#x26;&#x26; typeof args[0] === &#x22;string&#x22; &#x26;&#x26; args[0][0] === &#x22;{&#x22;) {
      cservice.options.<span class="apidocCodeKeywordSpan">debug</span>(&#x22;cservice:&#x22;.cservice);
    } else {
      args = [&#x22;cservice: &#x22;.cservice].concat(args);
    }
    cservice.options.debug.apply(this, args);
  }
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.util.error" id="apidoc.element.cluster-service.util.error">
        function <span class="apidocSignatureSpan">cluster-service.util.</span>error
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function error() {
  var args;
  var i;
  if (cservice.options.cli === true &#x26;&#x26; cservice.options.error) {
    if(process.stdout.clearLine){
      process.stdout.clearLine();
    }
    if(process.stdout.cursorTo){
      process.stdout.cursorTo(0);
    }

    args = Array.prototype.slice.call(arguments);
    for (i = 0; i &#x3c; args.length; i++) {
      if (typeof args[i] === &#x22;string&#x22;) {
        args[i] = args[i].error;
      }
    }
    if (args.length &#x3e; 0 &#x26;&#x26; typeof args[0] === &#x22;string&#x22; &#x26;&#x26; args[0][0] === &#x22;{&#x22;) {
      cservice.options.error(&#x22;cservice:&#x22;.cservice);
    } else {
      args = [&#x22;cservice: &#x22;.cservice].concat(args);
    }
    cservice.options.error.apply(this, args);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  process.stdin.pause();
} catch (ex) {
}
};

function onCommand(question) {
if (cservice.locals.isBusy === true) {
  cservice.<span class="apidocCodeKeywordSpan">error</span>(&#x22;Busy... Try again after previous command returns.&#x22;);
  return;
}

cservice.locals.isBusy = true;

var args;
question = question.replace(/[\r\n]/g, &#x22;&#x22;);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.util.getArgsFromQuestion" id="apidoc.element.cluster-service.util.getArgsFromQuestion">
        function <span class="apidocSignatureSpan">cluster-service.util.</span>getArgsFromQuestion
        <span class="apidocSignatureSpan">(question, delimiter)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function getArgsFromQuestion(question, delimiter) {

  // OLD WAY - simply breaks args by delimiter
  //var split = question.split(&#x22; &#x22;);
  //var args = [split[0], onCallback].concat(split.slice(1));

  // parser needs to be smarter, to account for various data types:
  // single word strings: hello
  // phrases: &#x22;hello world&#x22;
  // numbers: 1 or 1.3
  // JSON: [] or { &#x22;a&#x22;: { &#x22;b&#x22;: &#x22;hello \&#x22;world\&#x22;&#x22; } }
  var arg = []
    , args = []
    , stringOpen = false
    , jsonLevel = 0
    , arrayLevel = 0
    , i
    , isDelim
    , c
    , cprev
    , cnext;

  for (i = 0; i &#x3c; question.length; i++) {
    cprev = i &#x3e; 0 ? question[i - 1] : &#x22;&#x22;;
    c = question[i];
    cnext = (i &#x3c; question.length - 1) ? question[i + 1] : &#x22;&#x22;;
    isDelim = (c === delimiter);
    if (stringOpen === true) { // processing quotted string
      if (c === &#x22;\&#x22;&#x22; &#x26;&#x26; cprev !== &#x22;\\&#x22;) { // closer
        // close string
        stringOpen = false;
        // add string arg, even if empty
        args.push(getArgFromValue(arg.join(&#x22;&#x22;)));
        // reset arg
        arg = [];
      } else { // just another char
        arg.push(c);
      }
    } else if (jsonLevel &#x3e; 0) { // processing JSON object
      if (c === &#x22;}&#x22; &#x26;&#x26; cprev !== &#x22;\\&#x22;) { // closer
        jsonLevel--;
      } else if (c === &#x22;{&#x22; &#x26;&#x26; cprev !== &#x22;\\&#x22;) { // opener
        jsonLevel++;
      }

      arg.push(c);

      if (jsonLevel === 0) { // closed
        args.push(getArgFromValue(arg.join(&#x22;&#x22;)));
        // reset arg
        arg = [];
      }
    } else if (arrayLevel &#x3e; 0) { // processing JSON object
      if (c === &#x22;]&#x22; &#x26;&#x26; cprev !== &#x22;\\&#x22;) { // closer
        arrayLevel--;
      } else if (c === &#x22;[&#x22; &#x26;&#x26; cprev !== &#x22;\\&#x22;) { // opener
        arrayLevel++;
      }

      arg.push(c);

      if (arrayLevel === 0) { // closed
        args.push(getArgFromValue(arg.join(&#x22;&#x22;)));
        // reset arg
        arg = [];
      }
    } else { // processing basic arg
      if (c === delimiter) { // delimiter
        if (arg.length &#x3e; 0) { // if arg, add it
          args.push(getArgFromValue(arg.join(&#x22;&#x22;)));
          // reset arg
          arg = [];
        }
      } else if (c === &#x22;{&#x22; &#x26;&#x26; arg.length === 0) { // JSON opener
        jsonLevel++;
        arg.push(c);
      } else if (c === &#x22;[&#x22; &#x26;&#x26; arg.length === 0) { // Array opener
        arrayLevel++;
        arg.push(c);
      } else if (c === &#x22;\&#x22;&#x22; &#x26;&#x26; arg.length === 0) { // string opener
        stringOpen = true;
      } else { // add it
        arg.push(c);
      }
    }
  }

  if (arg.length &#x3e; 0) { // if arg remains, add it too
    args.push(getArgFromValue(arg.join(&#x22;&#x22;)));
  }

  return args;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  return;
}

cservice.locals.isBusy = true;

var args;
question = question.replace(/[\r\n]/g, &#x22;&#x22;);
args = require(&#x22;./util&#x22;).<span class="apidocCodeKeywordSpan">getArgsFromQuestion</span>(question, &#x22; &#x22;);
args = [args[0], onCallback].concat(args.slice(1));

if (!cservice.locals.events[args[0]]) {
  onCallback(&#x22;Command &#x22; + args[0] + &#x22; not found. Try &#x27;help&#x27;.&#x22;);

  return;
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.util.log" id="apidoc.element.cluster-service.util.log">
        function <span class="apidocSignatureSpan">cluster-service.util.</span>log
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function log() {
  var args;
  if (cservice.options.cli === true &#x26;&#x26; cservice.options.log) {
    if(process.stdout.clearLine){
      process.stdout.clearLine();
    }
    if(process.stdout.cursorTo){
      process.stdout.cursorTo(0);
    }

    args = Array.prototype.slice.call(arguments);
    if (args.length &#x3e; 0 &#x26;&#x26; typeof args[0] === &#x22;string&#x22; &#x26;&#x26; args[0][0] === &#x22;{&#x22;) {
      cservice.options.log(&#x22;cservice:&#x22;.cservice);
    } else {
      args = [&#x22;cservice: &#x22;.cservice].concat(args);
    }
    cservice.options.log.apply(this, args);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...


## Getting Started

Your existing application, be it console app or service of some kind:

	// server.js
	console.<span class="apidocCodeKeywordSpan">log</span>(&#x22;Hello World&#x22;);

Leveraging ```cluster-service``` without adding a line of code:

	npm install -g cluster-service
	cservice &#x22;server.js&#x22; --accessKey &#x22;lksjdf982734&#x22;
	// cserviced &#x22;server.js&#x22; --accessKey &#x22;lksjdf982734&#x22; // daemon
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.util.processSafeSend" id="apidoc.element.cluster-service.util.processSafeSend">
        function <span class="apidocSignatureSpan">cluster-service.util.</span>processSafeSend
        <span class="apidocSignatureSpan">(process, msg)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function processSafeSend(process, msg) {
  try {
    process.send(msg);
  } catch (ex) {
    return ex;
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  process.on(&#x22;message&#x22;, function(msg) {
    if (!cservice.msgBus.isValidMessage(msg)) {
      return; // ignore
    }

    switch (msg.cservice.cmd) {
      case &#x22;netStats&#x22;:
        cservice.<span class="apidocCodeKeywordSpan">processSafeSend</span>(process,
          cservice.msgBus.createMessage(&#x22;netStats&#x22;, {
            netStats: net
        }));
        break;
    }
  });
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.util.results" id="apidoc.element.cluster-service.util.results">
        function <span class="apidocSignatureSpan">cluster-service.util.</span>results
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function results() {
  if(cservice.options.log){
    cservice.options.log.apply(this, arguments);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    body.indexOf(&#x22;{&#x22;) === 0
    || body.indexOf(&#x22;[&#x22;) === 0
    )
  ) {
  body = JSON.parse(body); // deserialize
}
if (options.json === true) {
  cservice.<span class="apidocCodeKeywordSpan">results</span>(JSON.stringify(body));
} else {
  cservice.results(util.inspect(body, {depth: null, colors: true}));
}

if (cb) {
  cb(err, body);
}
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.version" id="apidoc.module.cluster-service.version">module cluster-service.version</a></h1>


    <h2>
        <a href="#apidoc.element.cluster-service.version.version" id="apidoc.element.cluster-service.version.version">
        function <span class="apidocSignatureSpan">cluster-service.</span>version
        <span class="apidocSignatureSpan">(evt, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">version = function (evt, cb) {
  var pkg = require(&#x22;../../package.json&#x22;);
  cb(null, pkg.version);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  break;
case &#x22;version&#x22;:
  versionStr = arguments[3];
  options = {};
  if (arguments[4]) {
    options.workerCount = parseInt(arguments[4]);
  }
  cservice.proxy.<span class="apidocCodeKeywordSpan">version</span>(versionStr, options, cb);
  break;
case &#x22;promote&#x22;:
  versionStr = arguments[3];
  options = {};
  if (arguments[4]) {
    options.workerCount = parseInt(arguments[4]);
  }
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.version.more" id="apidoc.element.cluster-service.version.more">
        function <span class="apidocSignatureSpan">cluster-service.version.</span>more
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">more = function (cb) {
  cb(null, {
    info: &#x22;Get version of cluster-service.&#x22;,
    command: &#x22;version&#x22;
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  if (typeof cmdName === &#x22;string&#x22;) {
ret.command = cmdName;
cmd = evt.locals.events[cmdName];
if (!cmd) {
  ret.err = &#x22;Command not found&#x22;;
} else {
  if (typeof cmd.cb.more === &#x22;function&#x22;) {
    cmd.cb.<span class="apidocCodeKeywordSpan">more</span>(function(err, result) {
      cb(null, result);
    });
    return;
  } else {
    ret.more = &#x22;No additional details found.&#x22;;
  }
}
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.workerExit" id="apidoc.module.cluster-service.workerExit">module cluster-service.workerExit</a></h1>




    <h2>
        <a href="#apidoc.element.cluster-service.workerExit.workerExit" id="apidoc.element.cluster-service.workerExit.workerExit">
        function <span class="apidocSignatureSpan">cluster-service.</span>workerExit
        <span class="apidocSignatureSpan">(evt, cb, worker, reason)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">workerExit = function (evt, cb, worker, reason) {
	cservice.log(
    (&#x22;Worker &#x22;
      + path.basename(worker.cservice.worker)
      + &#x22;(&#x22;
      + worker.process.pid
      + &#x22;) exited, reason: &#x22;
      + (reason || worker.cservice.reason ||
        cservice.locals.reason || &#x22;Unknown&#x22;)).warn
  );
  cb();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.workerExit.control" id="apidoc.element.cluster-service.workerExit.control">
        function <span class="apidocSignatureSpan">cluster-service.workerExit.</span>control
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">control = function () {
  return &#x22;inproc&#x22;;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
};
```

Or may be overriden at runtime via:

```javascript
// server.js
require(&#x22;cluster-service&#x22;).<span class="apidocCodeKeywordSpan">control</span>({ &#x22;exit&#x22;: &#x22;local&#x22; });
```

## Proxy Support

Proxy mode specifically caters to Web Servers that you want to enable automatic
versioning of your service. Any version requested (via `versionHeader`) that is
not yet loaded will automatically have a worker process spun up with the new
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.workerStart" id="apidoc.module.cluster-service.workerStart">module cluster-service.workerStart</a></h1>




    <h2>
        <a href="#apidoc.element.cluster-service.workerStart.workerStart" id="apidoc.element.cluster-service.workerStart.workerStart">
        function <span class="apidocSignatureSpan">cluster-service.</span>workerStart
        <span class="apidocSignatureSpan">(evt, cb, worker, reason)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">workerStart = function (evt, cb, worker, reason) {
	cservice.log(
    (&#x22;Worker &#x22;
      + path.basename(worker.cservice.worker)
      + &#x22;(&#x22;
      + worker.process.pid
      + &#x22;) start, reason: &#x22;
      + (reason || cservice.locals.reason || &#x22;Unknown&#x22;)).success
  );
  cb();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.workerStart.control" id="apidoc.element.cluster-service.workerStart.control">
        function <span class="apidocSignatureSpan">cluster-service.workerStart.</span>control
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">control = function () {
  return &#x22;inproc&#x22;;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
};
```

Or may be overriden at runtime via:

```javascript
// server.js
require(&#x22;cluster-service&#x22;).<span class="apidocCodeKeywordSpan">control</span>({ &#x22;exit&#x22;: &#x22;local&#x22; });
```

## Proxy Support

Proxy mode specifically caters to Web Servers that you want to enable automatic
versioning of your service. Any version requested (via `versionHeader`) that is
not yet loaded will automatically have a worker process spun up with the new
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.cluster-service.workers" id="apidoc.module.cluster-service.workers">module cluster-service.workers</a></h1>


    <h2>
        <a href="#apidoc.element.cluster-service.workers.demote" id="apidoc.element.cluster-service.workers.demote">
        function <span class="apidocSignatureSpan">cluster-service.workers.</span>demote
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function demote() {
  // only demote if:
  // 1. process.getgid is defined (not Windows)
  // 2. Running as root
  // 3. workerGid is string and not a proxy worker
  var gid = cservice.options.workerGid || &#x27;nobody&#x27;;
  var uid = cservice.options.workerUid || &#x27;nobody&#x27;;
  if (process.getgid &#x26;&#x26; process.getgid() === 0) {
    if ( // but do not auto-demote proxy
         // workers as they require priveledged port access
      cluster.worker.env.type !== &#x22;proxy&#x22; &#x26;&#x26;
      typeof cservice.options.workerGid === &#x27;string&#x27;
    ) {
      process.setgid(gid);
      process.setuid(uid);
    } else {
      cservice.log(
        &#x22;Worker running as root. Not advised for Production.&#x22; +
        &#x22; Consider workerGid &#x26; workerUid options.&#x22;.warn
      );
    }

  }

}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
){
// intermediate state to prevent 2nd call while async in progress
cluster.worker.module = {};
cluster.worker.env = process.env;

var workers = require(&#x22;./lib/workers&#x22;);

workers.<span class="apidocCodeKeywordSpan">demote</span>();

// load the worker if not already loaded
// async, in case worker loads cluster-service, we need to return before
// it&#x27;s avail
setImmediate(function() {
  cluster.worker.module = require(process.env.worker);
  if (global.cservice.locals.workerReady === undefined
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.workers.exitGracefully" id="apidoc.element.cluster-service.workers.exitGracefully">
        function <span class="apidocSignatureSpan">cluster-service.workers.</span>exitGracefully
        <span class="apidocSignatureSpan">(worker)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function exitGracefully(worker) {
  // inform the worker to exit gracefully
  worker.send(cservice.msgBus.createMessage(&#x22;onWorkerStop&#x22;));
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
          clearTimeout(oldWorkerTimeout);
        }

        // exit complete, fire callback
        setImmediate(cb); // slight delay in case other events are piled up
      });

      require(&#x22;../workers&#x22;).<span class="apidocCodeKeywordSpan">exitGracefully</span>(worker);
    });
  };
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.workers.get" id="apidoc.element.cluster-service.workers.get">
        function <span class="apidocSignatureSpan">cluster-service.workers.</span>get
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function get() {
  var workers = [];
  var cworkers = cluster.workers;
  var k;
  var worker;
  for (k in cworkers) {
    worker = cworkers[k];
    if ((!worker.isDead || !worker.isDead())
      &#x26;&#x26; worker.suicide !== true
      &#x26;&#x26; worker.state !== &#x22;none&#x22;) {
      worker.pid = worker.process.pid;
      workers.push(worker);
    }
  }

  workers.send = send;

  return workers;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.workers.getByPID" id="apidoc.element.cluster-service.workers.getByPID">
        function <span class="apidocSignatureSpan">cluster-service.workers.</span>getByPID
        <span class="apidocSignatureSpan">(pid)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function getByPID(pid) {
  var workers = get();
  var i;
  var worker;

  for (i = 0; i &#x3c; workers.length; i++) {
    worker = workers[i];
    if (worker.pid === pid) {
      return worker;
    }
  }
  // else return undefined
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.workers.getByPIDFromCache" id="apidoc.element.cluster-service.workers.getByPIDFromCache">
        function <span class="apidocSignatureSpan">cluster-service.workers.</span>getByPIDFromCache
        <span class="apidocSignatureSpan">(pid)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function getByPIDFromCache(pid) {
  return cservice.locals.workers[pid];
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.cluster-service.workers.monitor" id="apidoc.element.cluster-service.workers.monitor">
        function <span class="apidocSignatureSpan">cluster-service.workers.</span>monitor
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function monitor() {
  process.on(&#x22;message&#x22;, function(msg) {
    if (!cservice.msgBus.isValidMessage(msg)) {
      return; // end
    }

    switch (msg.cservice.cmd) {
      case &#x22;processDetails&#x22;:
        cservice.processSafeSend(process,
          cservice.msgBus.createMessage(&#x22;processDetails&#x22;, {
            processDetails: {
              memory: process.memoryUsage(),
              title: process.title,
              uptime: process.uptime(),
              hrtime: process.hrtime()
            }
        }));
        break;
    }
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
      exports.netServers.waitForReady(function() {
        exports.workerReady(); // NOW we&#x27;re ready
      });
    }
  });

  // start worker monitor to establish two-way relationship with master
  workers.<span class="apidocCodeKeywordSpan">monitor</span>();
}
...</pre></li>
    </ul>


</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
